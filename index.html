<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì†Œë°©ìš©ìˆ˜ í†µí•©ê´€ì œ v85</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: 'Malgun Gothic', sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” */
        .top-nav { background-color: #343a40; color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .top-nav h1 { margin: 0; font-size: 16px; display: flex; align-items: center; }
        .status-badge { background-color: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„: íŒŒì¼ëª… & ë²„íŠ¼ ì˜ì—­ */
        .control-panel { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 8px; background-color: #f8f9fa; border-bottom: 1px solid #dee2e6; gap: 8px; z-index: 10;
        }
        
        /* [í•µì‹¬ ìˆ˜ì •] íŒŒì¼ëª…ì´ ê¸¸ì–´ë„ ë²„íŠ¼ì„ ë°€ì–´ë‚´ì§€ ì•Šê²Œ ì²˜ë¦¬ */
        .file-info { 
            flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            color: #007bff; font-size: 13px; border: 1px dashed #ccc; padding: 6px; background: white;
        }

        /* ë²„íŠ¼ ê·¸ë£¹ ê³ ì • */
        .btn-group { display: flex; flex-shrink: 0; gap: 5px; }
        .btn { padding: 6px 8px; border: none; border-radius: 4px; font-size: 12px; font-weight: bold; cursor: pointer; color: white; }
        .btn-mail { background-color: #17a2b8; }
        .btn-excel { background-color: #28a745; }
        .btn-photo { background-color: #ffc107; color: #333; }

        /* ì§€ë„ ì˜ì—­ */
        #map { flex: 1; width: 100%; z-index: 1; }

        /* í•˜ë‹¨ ìš©ìˆ˜ ëª©ë¡ íŒ¨ë„ */
        .bottom-panel { height: 35%; background: white; display: flex; flex-direction: column; z-index: 5; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .panel-header { background: #495057; color: white; padding: 8px; display: flex; justify-content: space-between; align-items: center; }
        .list-container { flex: 1; overflow-y: auto; padding: 0; margin: 0; list-style: none; }
        .list-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; font-size: 13px; justify-content: space-between; align-items: center;}

        /* ì‚¬ì§„ ì´¬ì˜ìš© ìˆ¨ê¹€ ì¸í’‹ */
        #cameraInput { display: none; }
    </style>
</head>
<body>

    <div class="top-nav">
        <h1>ğŸš’ ì†Œë°©ìš©ìˆ˜ í†µí•©ê´€ì œ <span style="font-size:12px; color:#aaa; margin-left:5px;">v85</span></h1>
        <div class="status-badge">ğŸ“¡ ì‹¤ì‹œê°„ ì—°ë™ ì¤‘</div>
    </div>

    <div class="control-panel">
        <div class="file-info" id="fileNameDisplay">2026ë…„ 1ë¶„ê¸° ë‹´ì–‘êµ° ì†Œë°©ìš©ìˆ˜ì‹œì„¤ ê´€ë¦¬ëŒ€ì¥(ë‹´ì–‘)(ê¹€ë¯¼ì£¼).xlsx</div>
        <div class="btn-group">
            <button class="btn btn-photo" onclick="takePhoto()">ğŸ“· ì‚¬ì§„ì°ê¸°</button>
            <button class="btn btn-mail" onclick="sendAllData()">ê³µì§ìë©”ì¼ ì „ì†¡</button>
            <button class="btn btn-excel">ì—‘ì…€ ì €ì¥</button>
        </div>
    </div>

    <input type="file" accept="image/*" capture="environment" id="cameraInput">

    <div id="map"></div>

    <div class="bottom-panel">
        <div class="panel-header">
            <span>ğŸ“‹ ìš©ìˆ˜ ëª©ë¡ <button style="background:#28a745; color:white; border:none; border-radius:3px; padding:2px 5px; font-size:11px; margin-left:5px;">ì¼ê´„ ì–‘í˜¸ âœ”</button></span>
            <span style="background:#fd7e14; padding:3px 8px; border-radius:10px; font-size:12px; font-weight:bold;" id="photoCountBadge">ì‚¬ì§„: 0ì¥</span>
        </div>
        <div class="list-container" id="waterSupplyList">
            <div class="list-item" style="justify-content: center; color: #888;">ì—‘ì…€ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ë©´ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ==========================================
        // 1. ì§€ë„ ì´ˆê¸°í™” (ë‹´ì–‘ ì¸ê·¼ ì¢Œí‘œ ê¸°ì¤€)
        // ==========================================
        const map = L.map('map').setView([35.3218, 126.9880], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // ==========================================
        // 2. ì‚¬ì§„ ë°±ê·¸ë¼ìš´ë“œ ìë™ ì••ì¶• ë° ë³´ê´€ ë¡œì§
        // ==========================================
        const cameraInput = document.getElementById('cameraInput');
        let photoQueue = []; // ì••ì¶•ëœ ì‚¬ì§„ë“¤ì„ ì¡°ìš©íˆ ëª¨ì•„ë‘˜ ë°°ì—´ (ë³´ê´€í•¨)
        let photoCount = 0;

        // 'ğŸ“· ì‚¬ì§„ì°ê¸°' ë²„íŠ¼ í´ë¦­ ì‹œ ì¹´ë©”ë¼ í˜¸ì¶œ
        function takePhoto() {
            cameraInput.click();
        }

        // ì‚¬ì§„ì´ ì´¬ì˜ë˜ë©´ ë°”ë¡œ ì‹¤í–‰ë˜ëŠ” ìˆ¨ê²¨ì§„ ë¡œì§
        cameraInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // ê°€ë¡œí­ ìµœëŒ€ 1024pxë¡œ ì œí•œí•˜ì—¬ ìš©ëŸ‰ ìë™ ìµœì í™”
                    const MAX_WIDTH = 1024;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // í™•ì¸ íŒì—… ì—†ì´ ì¦‰ì‹œ ì••ì¶•(í’ˆì§ˆ 70%) í›„ ë³´ê´€í•¨ì— ì™ ë„£ê¸°
                    canvas.toBlob(function(blob) {
                        photoCount++;
                        const compressedFile = new File([blob], `ì ê²€ì‚¬ì§„_${photoCount}.jpg`, { type: 'image/jpeg' });
                        photoQueue.push(compressedFile);
                        
                        // í•˜ë‹¨ ëª©ë¡ íŒ¨ë„ì— ì‚¬ì§„ ëª‡ ì¥ ì°ì—ˆëŠ”ì§€ ìˆ«ìë§Œ ì—…ë°ì´íŠ¸
                        document.getElementById('photoCountBadge').innerText = `ì‚¬ì§„: ${photoCount}ì¥`;
                        console.log(`ì‚¬ì§„ ì €ì¥ ì™„ë£Œ: ${compressedFile.name} (${Math.round(compressedFile.size/1024)}KB)`);
                    }, 'image/jpeg', 0.7);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
            
            // ì—°ì†í•´ì„œ ì‚¬ì§„ì„ ì°ì„ ìˆ˜ ìˆë„ë¡ ì¸í’‹ ì´ˆê¸°í™”
            e.target.value = ''; 
        });
        // ==========================================
        // 3. ìŠ¤ë§ˆíŠ¸í° ì•±(ì´ë©”ì¼ ë“±)ìœ¼ë¡œ íŒŒì¼ ì¼ê´„ ê³µìœ  (Web Share API)
        // ==========================================
        function sendAllData() {
            if (photoQueue.length === 0) {
                if(!confirm("ì°ì€ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤. ì—‘ì…€ íŒŒì¼ë§Œ ì „ì†¡í• ê¹Œìš”?")) return;
            }

            // [ì„ì‹œ ì—‘ì…€ íŒŒì¼ ìƒì„± ì˜ì—­] 
            // â€» ì£¼ì˜: ì‹¤ì œ í˜„ì¥ ë°ì´í„°ê°€ ë‹´ê¸´ ì—‘ì…€ì„ ë³´ë‚´ì‹œë ¤ë©´, 
            // ê¸°ì¡´ì— ì“°ì‹œë˜ SheetJS ë“±ì˜ ì—‘ì…€ ìƒì„± ë¡œì§(Blob)ì„ ì´ ë¶€ë¶„ê³¼ êµì²´í•˜ì…”ì•¼ í•©ë‹ˆë‹¤.
            const dummyContent = "ì´ê²ƒì€ ì„ì‹œ ì ê²€ ê²°ê³¼ ì—‘ì…€ ë°ì´í„°ì…ë‹ˆë‹¤.";
            const excelBlob = new Blob([dummyContent], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const excelFile = new File([excelBlob], 'ì†Œë°©ìš©ìˆ˜_ì ê²€ê²°ê³¼.xlsx', { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

            // ì—‘ì…€ íŒŒì¼ í•˜ë‚˜ì™€, ê·¸ë™ì•ˆ ëª¨ì•„ë‘” ì‚¬ì§„(ë°°ì—´)ë“¤ì„ í•˜ë‚˜ì˜ í° ê¾¸ëŸ¬ë¯¸ë¡œ í•©ì¹©ë‹ˆë‹¤.
            const filesToShare = [excelFile, ...photoQueue];

            // ìŠ¤ë§ˆíŠ¸í° ë¸Œë¼ìš°ì €ê°€ íŒŒì¼ ê³µìœ (Share) ê¸°ëŠ¥ì„ ì§€ì›í•˜ëŠ”ì§€ ê²€ì‚¬
            if (navigator.canShare && navigator.canShare({ files: filesToShare })) {
                
                const mailBtn = document.querySelector('.btn-mail');
                mailBtn.innerText = "ì•± ì—¬ëŠ” ì¤‘..."; // ì§„í–‰ìƒíƒœ í‘œì‹œ

                // ìŠ¤ë§ˆíŠ¸í° í•˜ë‹¨ì—ì„œ ê³µìœ  ë©”ë‰´ ë„ìš°ê¸°
                navigator.share({
                    files: filesToShare,
                    title: 'ì†Œë°©ìš©ìˆ˜ ì ê²€ê²°ê³¼',
                    // ë©”ì¼ ì•±ì´ ì—´ë¦¬ë©´ ë³¸ë¬¸ì— ì•„ë˜ ë‚´ìš©ì´ ìë™ìœ¼ë¡œ ë“¤ì–´ê°‘ë‹ˆë‹¤.
                    // ì£¼ì†Œë¥¼ ê¾¹ ëˆŒëŸ¬ ë³µì‚¬í•˜ê¸° ì‰½ê²Œ ë§Œë“¤ì–´ ë‘ì—ˆìŠµë‹ˆë‹¤.
                    text: 'ì†Œë°©ìš©ìˆ˜ ì ê²€ê²°ê³¼ ì—‘ì…€ ë° ì‚¬ì§„ íŒŒì¼ì…ë‹ˆë‹¤.\n\nâ–¶ ë°›ëŠ” ì‚¬ëŒ ì£¼ì†Œ ë³µì‚¬ìš©:\nkmj88522@korea.kr' 
                })
                .then(() => {
                    console.log('ì´ë©”ì¼/ê³µìœ  ì•±ìœ¼ë¡œ íŒŒì¼ ë¬¶ìŒ ì „ë‹¬ ì„±ê³µ');
                    // ê³µìœ ê°€ ë¬´ì‚¬íˆ ëë‚˜ë©´ ë‹¤ìŒ ì ê²€ì„ ìœ„í•´ ì‚¬ì§„ ë³´ê´€í•¨ì„ ì‹¹ ë¹„ì›ë‹ˆë‹¤.
                    photoQueue = [];
                    photoCount = 0;
                    document.getElementById('photoCountBadge').innerText = "ì‚¬ì§„: 0ì¥";
                })
                .catch((error) => {
                    console.log('ê³µìœ ë¥¼ ì·¨ì†Œí–ˆê±°ë‚˜ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
                })
                .finally(() => {
                    mailBtn.innerText = "ê³µì§ìë©”ì¼ ì „ì†¡"; // ë²„íŠ¼ ì´ë¦„ ì›ìƒë³µêµ¬
                });

            } else {
                alert('í˜„ì¬ ë¸Œë¼ìš°ì €ì—ì„œëŠ” íŒŒì¼ ë‹¤ì¤‘ ê³µìœ  ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìŠ¤ë§ˆíŠ¸í°ì˜ í¬ë¡¬ì´ë‚˜ ì‚¼ì„± ì¸í„°ë„· ì•±ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
            }
        }
    </script>
</body>
</html>
