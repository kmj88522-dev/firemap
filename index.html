<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì†Œë°©ìš©ìˆ˜ í†µí•©ê´€ì œ v85</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: 'Malgun Gothic', sans-serif; display: flex; flex-direction: column; height: 100vh; }
        
        .top-nav { background-color: #343a40; color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        .top-nav h1 { margin: 0; font-size: 16px; display: flex; align-items: center; }
        .status-badge { background-color: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; }

        .control-panel { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 8px; background-color: #f8f9fa; border-bottom: 1px solid #dee2e6; gap: 10px; 
        }
        
        /* íŒŒì¼ëª… ê¸¸ì–´ì§ ë°©ì§€ (ë§ì¤„ì„í‘œ ì²˜ë¦¬) */
        .file-info { 
            flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            color: #007bff; font-size: 14px; border: 1px dashed #ccc; padding: 4px;
        }

        .btn-group { display: flex; flex-shrink: 0; gap: 5px; }
        .btn { padding: 6px 10px; border: none; border-radius: 4px; font-size: 13px; font-weight: bold; cursor: pointer; color: white; }
        .btn-mail { background-color: #17a2b8; }
        .btn-excel { background-color: #28a745; }
        .btn-reset { background-color: #6c757d; }
        .btn-photo { background-color: #ffc107; color: #333; }

        #map { flex: 1; width: 100%; z-index: 1; }

        .bottom-panel { height: 35%; background: white; display: flex; flex-direction: column; z-index: 2; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .panel-header { background: #495057; color: white; padding: 8px; display: flex; justify-content: space-between; align-items: center; }
        .list-container { flex: 1; overflow-y: auto; padding: 0; margin: 0; list-style: none; }
        .list-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; font-size: 13px; justify-content: space-between; align-items: center;}

        /* ì‚¬ì§„ ì´¬ì˜ìš© ìˆ¨ê¹€ ì¸í’‹ */
        #cameraInput { display: none; }
    </style>
</head>
<body>

    <div class="top-nav">
        <h1>ğŸš’ ì†Œë°©ìš©ìˆ˜ í†µí•©ê´€ì œ <span style="font-size:12px; color:#aaa; margin-left:5px;">v85</span></h1>
        <div class="status-badge">ğŸ“¡ ì‹¤ì‹œê°„ ì—°ë™ ì¤‘</div>
    </div>

    <div class="control-panel">
        <div class="file-info" id="fileNameDisplay">2026ë…„ 1ë¶„ê¸° ë‹´ì–‘êµ° ì†Œë°©ìš©ìˆ˜ì‹œì„¤ ê´€ë¦¬ëŒ€ì¥(ë‹´ì–‘)(ê¹€ë¯¼ì£¼).xlsx</div>
        <div class="btn-group">
            <button class="btn btn-photo" onclick="takePhoto()">ğŸ“· ì‚¬ì§„</button>
            <button class="btn btn-mail" onclick="sendAllData()">ê³µì§ìë©”ì¼ ì „ì†¡</button>
            <button class="btn btn-excel">ì—‘ì…€ ì €ì¥</button>
        </div>
    </div>

    <input type="file" accept="image/*" capture="environment" id="cameraInput">

    <div id="map"></div>

    <div class="bottom-panel">
        <div class="panel-header">
            <span>ğŸ“‹ ìš©ìˆ˜ ëª©ë¡ <button style="background:#28a745; color:white; border:none; border-radius:3px; padding:2px 5px; font-size:11px;">ì¼ê´„ ì–‘í˜¸ âœ”</button></span>
            <span style="background:#fd7e14; padding:2px 8px; border-radius:10px; font-size:12px;" id="photoCountBadge">ì°ì€ ì‚¬ì§„: 0ì¥</span>
        </div>
        <div class="list-container">
            <div class="list-item">028 | ë¯¸ì ê²€ | ë‹´ì–‘ì ì‹œì‚°2ê¸¸ 2</div>
            <div class="list-item">029 | ì–‘í˜¸ | ë‹´ì–‘ì ì–‘ê°ìƒ›í„°ê¸¸ 2-7</div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ì§€ë„ ì´ˆê¸°í™”
        const map = L.map('map').setView([35.3218, 126.9880], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // ==========================================
        // 1. ì‚¬ì§„ ë°±ê·¸ë¼ìš´ë“œ ìë™ ì••ì¶• ë° ë³´ê´€
        // ==========================================
        const cameraInput = document.getElementById('cameraInput');
        let photoQueue = []; // ì••ì¶•ëœ ì‚¬ì§„ íŒŒì¼ ê°ì²´ë¥¼ ë‹´ì„ ë°°ì—´
        let photoCount = 0;

        function takePhoto() {
            cameraInput.click();
        }

        cameraInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // ê°€ë¡œ ìµœëŒ€ 1024pxë¡œ ë¦¬ì‚¬ì´ì§•
                    const MAX_WIDTH = 1024;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // í’ˆì§ˆ 70%ë¡œ ì¦‰ì‹œ ì••ì¶• ë° ë°°ì—´ì— ì¶”ê°€
                    canvas.toBlob(function(blob) {
                        photoCount++;
                        // File ê°ì²´ë¡œ ë³€í™˜í•˜ì—¬ ë°°ì—´ì— ì €ì¥
                        const compressedFile = new File([blob], `ì ê²€ì‚¬ì§„_${photoCount}.jpg`, { type: 'image/jpeg' });
                        photoQueue.push(compressedFile);
                        
                        // í™”ë©´ ë±ƒì§€ ì—…ë°ì´íŠ¸
                        document.getElementById('photoCountBadge').innerText = `ì°ì€ ì‚¬ì§„: ${photoCount}ì¥`;
                        console.log(`ì‚¬ì§„ ì €ì¥ë¨: ${compressedFile.name} (${Math.round(compressedFile.size/1024)}KB)`);
                    }, 'image/jpeg', 0.7);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
            
            e.target.value = ''; // ê°™ì€ ì‚¬ì§„ ì¬ì´¬ì˜ ê°€ëŠ¥í•˜ê²Œ ì´ˆê¸°í™”
        });

        // ==========================================
        // 2. ìŠ¤ë§ˆíŠ¸í° ì•±(ì´ë©”ì¼ ë“±)ìœ¼ë¡œ íŒŒì¼ ì¼ê´„ ê³µìœ  (Web Share API)
        // ==========================================
        function sendAllData() {
            if (photoQueue.length === 0) {
                if(!confirm("ì°ì€ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤. ì—‘ì…€ íŒŒì¼ë§Œ ì „ì†¡í• ê¹Œìš”?")) return;
            }

            // [ì„ì‹œ ì—‘ì…€ íŒŒì¼ ìƒì„±] 
            // â€» ì‹¤ì œ ì ìš© ì‹œì—ëŠ” ê¸°ì¡´ì— ì‚¬ìš©í•˜ì‹œë˜ SheetJS ë“±ìœ¼ë¡œ ë§Œë“  ì—‘ì…€ Blobì„ ì—¬ê¸°ì— ë„£ìœ¼ì‹œë©´ ë©ë‹ˆë‹¤.
            const dummyContent = "ì´ê²ƒì€ ì ê²€ ê²°ê³¼ ì—‘ì…€ ë°ì´í„°ì…ë‹ˆë‹¤.";
            const excelBlob = new Blob([dummyContent], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const excelFile = new File([excelBlob], 'ì†Œë°©ìš©ìˆ˜_ì ê²€ê²°ê³¼.xlsx', { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

            // ì—‘ì…€ íŒŒì¼ê³¼ ê·¸ë™ì•ˆ ëª¨ì•„ë‘” ì‚¬ì§„ë“¤ì„ í•˜ë‚˜ì˜ ë°°ì—´ë¡œ í•©ì¹¨
            const filesToShare = [excelFile, ...photoQueue];

            // ìŠ¤ë§ˆíŠ¸í° ë¸Œë¼ìš°ì €ê°€ íŒŒì¼ ê³µìœ  ê¸°ëŠ¥ì„ ì§€ì›í•˜ëŠ”ì§€ ì²´í¬
            if (navigator.canShare && navigator.canShare({ files: filesToShare })) {
                
                const mailBtn = document.querySelector('.btn-mail');
                mailBtn.innerText = "ì•± ì—¬ëŠ” ì¤‘...";

                navigator.share({
                    files: filesToShare,
                    title: 'ì†Œë°©ìš©ìˆ˜ ì ê²€ê²°ê³¼',
                    // ë©”ì¼ ì•±ì´ ì—´ë ¸ì„ ë•Œ ë³¸ë¬¸ì— ë“¤ì–´ê°ˆ ë‚´ìš© (ì£¼ì†Œë¥¼ ë³µì‚¬í•˜ê¸° ì‰½ê²Œ ì ì–´ë‘ )
                    text: 'ì†Œë°©ìš©ìˆ˜ ì ê²€ê²°ê³¼ ì—‘ì…€ ë° ì‚¬ì§„ íŒŒì¼ì…ë‹ˆë‹¤.\n\nâ–¶ ë°›ëŠ” ì‚¬ëŒ ì£¼ì†Œ ë³µì‚¬ìš©:\nkmj88522@korea.kr' 
                })
                .then(() => {
                    console.log('ì´ë©”ì¼/ê³µìœ  ì•±ìœ¼ë¡œ íŒŒì¼ ì „ë‹¬ ì„±ê³µ');
                    // ê³µìœ  ì™„ë£Œ í›„ ì‚¬ì§„ ë³´ê´€í•¨ ì´ˆê¸°í™” (ìƒˆë¡œìš´ ì ê²€ì„ ìœ„í•´)
                    photoQueue = [];
                    photoCount = 0;
                    document.getElementById('photoCountBadge').innerText = "ì°ì€ ì‚¬ì§„: 0ì¥";
                })
                .catch((error) => {
                    console.log('ê³µìœ  ì·¨ì†Œ ë˜ëŠ” ì—ëŸ¬:', error);
                })
                .finally(() => {
                    mailBtn.innerText = "ê³µì§ìë©”ì¼ ì „ì†¡";
                });

            } else {
                alert('í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ë¸Œë¼ìš°ì €ì—ì„œëŠ” íŒŒì¼ ë‹¤ì¤‘ ê³µìœ  ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìŠ¤ë§ˆíŠ¸í°ì˜ í¬ë¡¬ì´ë‚˜ ì‚¼ì„± ì¸í„°ë„·ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
            }
        }
    </script>
</body>
</html>
