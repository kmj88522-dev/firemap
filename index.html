<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ğŸš’ ì†Œë°©ìš©ìˆ˜ í†µí•©ê´€ì œ v84 (UIìµœì í™”)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<style>
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; font-family: 'Malgun Gothic', sans-serif; width: 100vw; height: 100vh; height: 100dvh; position: fixed; top: 0; left: 0; display: flex; flex-direction: column; overflow: hidden; background-color: #f4f6f9; }
    
    /* âœ¨ í—¤ë” ë””ìì¸ ë³€ê²½ (ìŠ¤í¬ë¡¤ íŒŒì¼ëª… & ì´ˆë¡ ê¹œë¹¡ì´) */
    #header { height:40px; background:#2c3e50; color:white; display:flex; align-items:center; justify-content:space-between; padding:0 10px; border-bottom:3px solid #ff9f43; flex-shrink: 0; z-index: 5000; position: relative; }
    .header-title { font-size:1.05rem; white-space:nowrap; margin:0; }
    .header-marquee { flex:1; margin:0 15px; overflow:hidden; display:none; align-items:center; }
    @keyframes blink { 0% { opacity:1; } 50% { opacity:0.2; } 100% { opacity:1; } }
    .sync-circle { width:12px; height:12px; border-radius:50%; background-color:#2ecc71; animation: blink 1.5s infinite; box-shadow: 0 0 8px #2ecc71; display:none; flex-shrink: 0; margin-right:5px;}
    
    #container { display:flex; flex:1; height:calc(100dvh - 40px); position:relative; width: 100%; overflow: hidden; }
    
    /* ë°ìŠ¤í¬íƒ‘ ê¸°ë³¸ íŒ¨ë„ */
    #left-panel { width:240px; background:white; border-right:1px solid #ccc; display:flex; flex-direction:column; padding:10px; z-index:1000; flex-shrink: 0; gap: 8px;}
    #drop-zone { border: 2px dashed #bdc3c7; border-radius: 6px; background: #fafafa; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: #7f8c8d; cursor: pointer; transition: all 0.3s ease; padding: 15px 5px; min-height: 80px; filter: grayscale(100%); opacity: 0.7;}
    #drop-zone.loaded { filter: none; opacity: 1; border-color: #2ecc71; background: #eafaf1; }
    #drop-zone .icon { font-size: 1.8rem; margin-bottom: 5px; }
    #file-status { font-size: 0.85rem; font-weight: bold; line-height: 1.3; word-break: break-all;}
    
    .action-btns { display: flex; flex-direction: column; gap: 5px; }
    .btn-blue { width:100%; padding:8px; background:#2980b9; color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer; font-size:0.9rem;}
    .btn-gray { width:100%; padding:8px; background:#95a5a6; color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer; font-size:0.9rem;}
    .btn-green { width:100%; padding:8px; background:#27ae60; color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer; font-size:0.9rem;}
    .btn-purple { width:100%; padding:8px; background:#8e44ad; color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer; font-size:0.9rem;}

    #map-wrapper { flex:1; position: relative; z-index: 1; min-height: 250px; }
    #map { position: absolute; top: 0; left: 0; right: 0; bottom: 0; }
    
    #right-panel { width:45%; min-width:350px; background:white; border-left:1px solid #ccc; display:flex; flex-direction:column; z-index:1000; flex-shrink: 0; position: relative; overflow: hidden; }
    
    .overlay { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; display:none; justify-content:center; align-items:center; }
    .modal { background:white; width:95%; max-width:380px; padding:20px; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,0.5); border-top:5px solid #2980b9; max-height: 90vh; overflow-y: auto; }
    #status-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; background: #ffffff; z-index: 2000; display: none; flex-direction: column; padding: 10px 15px; overflow-y: auto; box-sizing: border-box; }
    #overlay-list { display:grid; grid-template-columns:1fr 1fr; gap:8px; max-height:250px; overflow-y:auto; margin:15px 0; border:1px solid #eee; padding:10px; background:#f9f9f9;}
    .mgr-label { cursor:pointer; display:flex; align-items:center; font-size:0.9rem; padding:6px; border-radius:4px; background:white; border:1px solid #ddd;}
    
    #modal-shortNum { transition: background 0.3s ease, color 0.3s ease; border-radius: 5px; }
    .modal-info-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; text-align: left; margin-bottom: 8px; line-height: 1.2; }
    .modal-info-table th { background: #f1f2f6; padding: 4px 6px; border: 1px solid #ddd; color: #333; width: 25%; white-space: nowrap; }
    .modal-info-table td { padding: 4px 6px; border: 1px solid #ddd; color: #2c3e50; font-weight: bold; word-break: break-all;}
    .status-btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 5px; }
    .status-select-btn { padding: 8px 5px; border:none; border-radius:5px; color:white; font-weight:bold; cursor:pointer; font-size:0.85rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .badge-status { padding: 3px 0; border-radius: 3px; font-size: 0.7rem; font-weight: bold; color: white; cursor: pointer; border: none; width: 90%; margin: 0 auto; display: block; line-height: 1.2; box-shadow: 0 1px 2px rgba(0,0,0,0.2); transition: all 0.3s ease;}
    .status-none { background: #95a5a6; } .status-good { background: #27ae60; } .status-warn { background: #f39c12; } .status-fail { background: #e74c3c; } 
    
    .info-table { width:100%; border-collapse:collapse; font-size:0.75rem; table-layout:fixed; }
    .info-table th { background:#34495e; color:white; padding:6px 2px; position:sticky; top:0; z-index:10; white-space:nowrap; font-size: 0.75rem; position:relative; }
    .info-table td { border-bottom:1px solid #ddd; padding: 4px 2px; text-align:center; word-break:keep-all; vertical-align:middle; line-height:1.1; overflow:hidden; text-overflow:ellipsis; transition: background 0.3s; }
    .info-table tr:hover { filter: brightness(0.95); cursor:pointer; }
    .selected-row { border-left:4px solid #e67e22; font-weight:bold; filter: brightness(0.9); }
    .error-row { background:#ffebee !important; color:#c0392b; }
    .circle-marker { display:flex; justify-content:center; align-items:center; border-radius:50%; font-weight:900; font-family:'Arial Black', sans-serif; box-shadow:0 3px 6px rgba(0,0,0,0.4); transition:transform 0.3s ease, background 0.3s ease, color 0.3s ease; }
    .circle-marker:hover { transform: scale(1.1); }
    
    #gps-btn { position: absolute; bottom: 20px; right: 20px; z-index: 2000; background: white; border: 2px solid #2980b9; color: #2980b9; border-radius: 50px; padding: 10px 15px; font-weight: bold; font-size: 0.85rem; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: all 0.3s ease; }
    #gps-btn.active { background: #e74c3c; color: white; border-color: #c0392b; }
    #loading { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; display:none; justify-content:center; align-items:center; color:white; flex-direction:column; font-size:1.1rem; font-weight:bold;}
    .spinner { width:50px; height:50px; border:5px solid #f3f3f3; border-top:5px solid #e67e22; border-radius:50%; animation:spin 1s linear infinite; margin-bottom:15px; }
    @keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
    #photo-canvas-container { width: 100%; overflow: hidden; margin-top: 10px; border: 2px solid #ddd; display: none; touch-action: none; }
    #photo-canvas { width: 100%; height: auto; display: block; cursor: crosshair; }
    
    /* âœ¨âœ¨âœ¨ ëŒ€ë§ì˜ ëª¨ë°”ì¼ UI 1ë‹¨ ì••ì¶• (ê°€ë¦¼ ì™„ì „ ì œê±°) âœ¨âœ¨âœ¨ */
    @media (max-width: 768px) {
        #container { flex-direction: column; overflow: hidden; height: calc(100dvh - 40px); }
        
        /* 1. ìƒë‹¨ ì»¨íŠ¸ë¡¤ íŒ¨ë„ì„ ì–‡ì€ 45px 1ë‹¨ ê°€ë¡œì¤„ë¡œ ì™„ë²½ ê³ ì • */
        #left-panel { flex-direction: row; width: 100%; height: 45px; padding: 4px 8px; border-right: none; border-bottom: 2px solid #2980b9; gap: 8px; align-items: center; z-index: 100; overflow: hidden; }
        
        /* 2. í´ë” ì²¨ë¶€ ë²„íŠ¼: ë„¤ëª¨ ë°˜ë“¯í•œ ì•„ì´ì½˜ í•˜ë‚˜ë¡œ ìµœì†Œí™” (ê¸€ì ì‚­ì œ) */
        #drop-zone { flex: 0 0 35px; width: 35px; height: 35px; min-height: 35px; padding: 0; justify-content: center; margin: 0; }
        #drop-zone .icon { font-size: 1.4rem; margin: 0; }
        #file-status { display: none; } /* íŒŒì¼ëª… í…ìŠ¤íŠ¸ ìˆ¨ê¹€ (í—¤ë”ë¡œ ì´ë™) */
        
        /* 3. ì•¡ì…˜ ë²„íŠ¼ 3ê°œ: 2ë‹¨ ìŒ“ì„ ë°©ì§€, ê°€ë¡œë¡œ ì–‡ê²Œ ì«™ í´ê¸° */
        .action-btns { display: flex; flex-direction: row; flex: 1; gap: 4px; height: 35px; align-items: center; }
        .action-btns button { flex: 1; height: 100%; padding: 0; font-size: 0.75rem; margin: 0; white-space: nowrap; border-radius: 4px; }
        
        #map-wrapper { flex: 1; min-height: 40vh; width: 100%; z-index: 1; }
        #right-panel { height: 40vh; width: 100%; border-left: none; border-top: 2px solid #34495e; position: relative; overflow: hidden; z-index: 10; }
    }
</style>
</head>
<body>

<div id="loading"><div class="spinner"></div><div id="loading-msg" style="text-align:center;">ì²˜ë¦¬ ì¤‘...</div></div>
<input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;">

<div id="manager-overlay" class="overlay">
    <div class="modal">
        <h3 style="margin-top:0; color:#2c3e50;">ğŸ‘¤ ë‹´ë‹¹ì ì„ íƒ</h3>
        <div id="overlay-list"></div>
        <div style="display:flex; flex-direction:column; gap:5px;">
            <button class="btn-blue" onclick="confirmManager()">âœ… í™•ì¸</button>
            <div style="display:flex; gap:5px;">
                <button class="btn-gray" style="flex:1; background:#7f8c8d;" onclick="resetManagerSelection()">ğŸ”„ ì„ íƒ ì´ˆê¸°í™”</button>
                <button class="btn-gray" style="flex:1;" onclick="document.getElementById('manager-overlay').style.display='none'">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<div id="header">
    <h3 class="header-title">ğŸš’ ì†Œë°©ìš©ìˆ˜ <span style="font-size:0.7rem; font-weight:normal; color:#bdc3c7;">v84</span></h3>
    <div class="header-marquee" id="header-filename-area">
        <marquee scrollamount="4" style="font-size:0.85rem; color:#f1c40f; font-weight:bold;" id="header-filename"></marquee>
    </div>
    <div class="sync-circle" id="sync-indicator"></div>
</div>

<div id="container">
    <div id="left-panel">
        <label id="drop-zone" for="excelFile">
            <div class="icon">ğŸ“‚</div>
            <div id="file-status">ì—‘ì…€ ë¡œë“œ</div>
            <input type="file" id="excelFile" accept=".xlsx" style="display:none;" />
        </label>
        <div class="action-btns">
            <button class="btn-purple" onclick="sendReportEmail()">ğŸ“§ ë©”ì¼ë³´ê³ </button>
            <div>
                <button class="btn-green" style="flex:1;" onclick="exportExcel()">ğŸ’¾ ì €ì¥</button>
                <button class="btn-gray" style="flex:1;" onclick="resetWork()">ğŸ”„ ì´ˆê¸°í™”</button>
            </div>
        </div>
    </div>

    <div id="map-wrapper">
        <div id="map"></div>
        <button id="gps-btn" onclick="toggleGPS()">ğŸ¯ ë‚´ ìœ„ì¹˜ í‘œì‹œ</button>
    </div>

    <div id="right-panel">
        <div style="padding:4px 10px; background:#34495e; color:white; display:flex; justify-content:space-between; align-items:center;">
            <div style="display:flex; align-items:center; gap: 8px;">
                <span style="font-size:0.85rem; font-weight:bold;">ğŸ“‹ ìš©ìˆ˜ ëª©ë¡</span>
                <button onclick="setAllGood()" style="background:#27ae60; color:white; border:1px solid #2ecc71; border-radius:4px; padding:3px 8px; font-size:0.75rem; font-weight:bold; cursor:pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.3);">ì¼ê´„ ì–‘í˜¸ âœ…</button>
            </div>
            <span id="count-badge" style="background:#e67e22; padding:2px 8px; border-radius:12px; font-size:0.75rem; font-weight:bold;">0ê±´</span>
        </div>
        <div style="overflow:auto; flex:1;">
            <table class="info-table">
                <thead>
                    <tr><th style="width:8%;">ë²ˆí˜¸</th><th style="width:12%;">ìƒíƒœ</th><th style="width:10%;">ë‹´ë‹¹</th><th style="width:18%;">ë„ë¡œëª…</th><th style="width:14%;">ì§€ë²ˆ</th><th style="width:22%;">ìƒì„¸</th><th style="width:6%;">í‘œì§€</th><th style="width:5%;">ì œìˆ˜</th><th style="width:5%;">ë³´í˜¸</th></tr>
                </thead>
                <tbody id="listBody"><tr><td colspan="9" style="padding:30px; color:#aaa; text-align:center;">ì—‘ì…€ íŒŒì¼ì„ ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr></tbody>
            </table>
        </div>

        <div id="status-overlay">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 2px solid #ff9f43; padding-bottom: 3px; margin-bottom: 8px;">
                <h3 id="modal-shortNum" style="margin:0; font-size:0.95rem; padding: 4px 8px;">ğŸ“‹ ìƒì„¸ì •ë³´ ë° ì ê²€</h3>
                <button onclick="closeStatusModal()" style="background:none; border:none; font-size:1.1rem; cursor:pointer; padding-right:5px;">âŒ</button>
            </div>
            
            <div id="default-info-area">
                <table class="modal-info-table">
                    <tr><th>ë‹´ë‹¹ì</th><td id="modal-mgr"></td></tr>
                    <tr><th>ìœ„ì¹˜</th><td><span id="modal-road"></span><br><span id="modal-jibun" style="font-size:0.7rem; color:#7f8c8d;"></span></td></tr>
                    <tr><th>ìƒì„¸/ì‹œì„¤</th><td><span id="modal-detail"></span><br><span style="font-size:0.7rem; color:#7f8c8d;">(í‘œì§€:<span id="modal-sign"></span> ì œìˆ˜:<span id="modal-valve"></span> ë³´í˜¸:<span id="modal-guard"></span>)</span></td></tr>
                    <tr><th>íŠ¹ì´ì‚¬í•­</th><td id="modal-memo" style="color:#e74c3c;">-</td></tr>
                </table>
                <div class="status-btn-grid">
                    <button class="status-select-btn" style="background:#27ae60;" onclick="saveStatus('ì–‘í˜¸')">ğŸŸ¢ ì–‘í˜¸</button>
                    <button class="status-select-btn" style="background:#f39c12;" onclick="saveStatus('ë¶ˆëŸ‰')">ğŸŸ  ë¶ˆëŸ‰</button>
                    <button class="status-select-btn" style="background:#e74c3c;" onclick="saveStatus('ê³ ì¥')">ğŸ”´ ê³ ì¥</button>
                    <button class="status-select-btn" style="background:#95a5a6;" onclick="saveStatus('ë¯¸ì ê²€')">âšª ì´ˆê¸°í™”</button>
                </div>
                <button class="btn-blue" style="margin-top:2px; background:#3498db;" onclick="triggerCamera()">ğŸ“· í˜„ì¥ ì‚¬ì§„ ì´¬ì˜ ë° ë³´ê´€</button>
            </div>

            <div id="photo-editor-area" style="display:none;">
                <p style="font-size:0.75rem; color:#e67e22; margin: 2px 0; font-weight:bold;">ğŸ’¡ ì‚¬ì§„ ì† ì œìˆ˜ë³€ ìœ„ì¹˜ë¥¼ í„°ì¹˜í•˜ì—¬ í‘œì‹œí•˜ì„¸ìš”.</p>
                <div id="photo-canvas-container">
                    <canvas id="photo-canvas"></canvas>
                </div>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <button class="btn-green" style="flex:1;" onclick="saveEditedPhoto()">ğŸ’¾ ì••ì¶•ë³´ê´€ (ë©”ì¼ìš©)</button>
                    <button class="btn-gray" style="flex:1; background:#e74c3c;" onclick="cancelPhotoEdit()">âŒ ì·¨ì†Œ</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
        window.addEventListener(evt, e => e.preventDefault(), { capture: true });
        document.addEventListener(evt, e => e.preventDefault(), { capture: true });
    });

    const API_URL = "https://koreanparamedics.pythonanywhere.com";
    const COL = { NUM: 7, ROAD: 9, JIBUN: 10, DETAIL: 11, LAT: 12, LNG: 13, SIGN: 18, VALVE: 20, GUARD: 21, MGR: 27 };
    const ACTIVE_COLORS = ['#ff4757', '#2ed573', '#1e90ff']; 

    let map, markers=[], workbook=null, worksheet=null, loadedRows=[];
    let currentEditItem = null; 
    let syncInterval = null; 
    let currentRoomId = "default_room"; 

    map = L.map('map', { zoomControl: false }).setView([35.32, 126.98], 11);
    L.control.zoom({ position: 'bottomleft' }).addTo(map); 
    
    const vworldBase = L.tileLayer('https://xdworld.vworld.kr/2d/Base/service/{z}/{x}/{y}.png', { maxZoom: 19 });
    vworldBase.addTo(map);

    function getLightColor(hexColor) {
        if(!hexColor || hexColor.length < 7) return 'rgba(255, 255, 255, 0)';
        let r = parseInt(hexColor.slice(1, 3), 16), g = parseInt(hexColor.slice(3, 5), 16), b = parseInt(hexColor.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, 0.12)`; 
    }

    function createMarkerIcon(shortNum, mgrColor, status) {
        let textColor = '#ffffff'; 
        if (status === 'ì–‘í˜¸') textColor = '#2ecc71'; 
        if (status === 'ë¶ˆëŸ‰') textColor = '#f1c40f'; 
        if (status === 'ê³ ì¥') textColor = '#ff4757'; 
        return L.divIcon({ className:'', html: `<div class="circle-marker" style="background:#1e272e; color:${textColor}; border:3px solid ${mgrColor}; width:26px; height:26px; font-size:11px; letter-spacing:-0.5px;">${shortNum}</div>`, iconSize:[26,26], iconAnchor:[13,13] });
    }

    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('excelFile');
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => dropZone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); }));
    dropZone.addEventListener('dragover', () => dropZone.classList.add('dragover'));
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', e => { dropZone.classList.remove('dragover'); if(e.dataTransfer && e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]); });
    fileInput.addEventListener('change', e => { if(e.target.files.length > 0) handleFile(e.target.files[0]); });

    async function handleFile(file) {
        if(!file) return;
        currentRoomId = file.name;
        document.getElementById('loading-msg').innerText = "íŒŒì¼ ì½ëŠ” ì¤‘...";
        document.getElementById('loading').style.display = 'flex';
        try {
            const buffer = await file.arrayBuffer();
            workbook = new ExcelJS.Workbook();
            await workbook.xlsx.load(buffer);
            worksheet = workbook.worksheets[0];
            loadedRows = [];
            
            worksheet.eachRow((row, rowNumber) => { 
                if(rowNumber >= 3) {
                    loadedRows.push({ row: row, num: rowNumber, status: 'ë¯¸ì ê²€', shortNum: '', mgrColor: '#333', marker: null, mgrName: '', memo: '', photoBase64: null }); 
                }
            });
            
            try {
                const res = await fetch(API_URL + '/data?room=' + encodeURIComponent(currentRoomId) + '&t=' + new Date().getTime());
                const serverData = await res.json();
                loadedRows.forEach(item => {
                    const sData = serverData[item.num];
                    if(sData) { item.status = sData.status; item.memo = sData.memo || ''; }
                });
            } catch(e) { console.log("ì„œë²„ ì—°ê²° ì‹¤íŒ¨"); }

            // âœ¨ íŒŒì¼ ì²¨ë¶€ ì„±ê³µ ì‹œ: í´ë” ì•„ì´ì½˜ì— ìƒ‰ì„ ì…íˆê³ , ìƒë‹¨ ì „ê´‘íŒì— íŒŒì¼ëª… í‘œì‹œ
            dropZone.classList.add('loaded'); 
            document.getElementById('header-filename-area').style.display = 'flex';
            document.getElementById('header-filename').innerText = file.name;

            showManagerOverlay();
            startRealtimeSync();

        } catch(err) { alert("ì—‘ì…€ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); } 
        finally { document.getElementById('loading').style.display = 'none'; fileInput.value = ''; }
    }

    function startRealtimeSync() {
        if(syncInterval) clearInterval(syncInterval);
        document.getElementById('sync-indicator').style.display = 'block'; 
        
        syncInterval = setInterval(async () => {
            if(loadedRows.length === 0) return;
            try {
                const res = await fetch(API_URL + '/data?room=' + encodeURIComponent(currentRoomId) + '&t=' + new Date().getTime());
                const serverData = await res.json();
                loadedRows.forEach(item => {
                    const sData = serverData[item.num];
                    if(sData && (item.status !== sData.status || item.memo !== sData.memo)) {
                        item.status = sData.status; item.memo = sData.memo || '';
                        const rowBtn = document.querySelector(`#row-${item.num} .badge-status`);
                        if(rowBtn) {
                            let statusClass = 'status-none'; 
                            if(item.status === 'ì–‘í˜¸') statusClass = 'status-good'; else if(item.status === 'ë¶ˆëŸ‰') statusClass = 'status-warn'; else if(item.status === 'ê³ ì¥') statusClass = 'status-fail'; 
                            rowBtn.innerText = item.status + (item.memo ? " ğŸ’¬" : ""); rowBtn.className = `badge-status ${statusClass}`;
                        }
                        if(item.marker) item.marker.setIcon(createMarkerIcon(item.shortNum, item.mgrColor, item.status)); 
                        if(currentEditItem && currentEditItem.num === item.num) {
                            document.getElementById('modal-memo').innerText = item.memo || '-'; updateModalHeaderColor(item.status);
                        }
                    }
                });
            } catch(e) {}
        }, 3000); 
    }

    function showManagerOverlay() {
        const mgrSet = new Set();
        loadedRows.forEach(item => { const val = item.row.getCell(COL.MGR).value; if(val) mgrSet.add(val.toString().trim()); });
        const list = document.getElementById('overlay-list'); list.innerHTML = "";
        [...mgrSet].sort().forEach((mgr) => { const div = document.createElement('div'); div.innerHTML = `<label class="mgr-label"><input type="checkbox" class="mgr-check" value="${mgr}" style="margin-right:8px;">${mgr}</label>`; list.appendChild(div); });
        document.getElementById('manager-overlay').style.display = 'flex';
    }

    function resetManagerSelection() { document.querySelectorAll('.mgr-check').forEach(cb => cb.checked = false); }

    function confirmManager() {
        const checks = document.querySelectorAll('.mgr-check:checked');
        if(checks.length === 0) return alert("ìµœì†Œ 1ëª…ì˜ ë‹´ë‹¹ìë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        const targets = Array.from(checks).map((c, idx) => ({ name: c.value, color: ACTIVE_COLORS[idx] || '#333' }));
        document.getElementById('manager-overlay').style.display = 'none';
        setTimeout(() => map.invalidateSize(), 300); renderMapAndTable(targets);
    }
    function renderMapAndTable(targets) {
        markers.forEach(m => map.removeLayer(m)); markers = [];
        const tbody = document.getElementById('listBody'); tbody.innerHTML = "";
        const bounds = []; const targetNames = targets.map(t => t.name); let validCount = 0;

        loadedRows.forEach(item => {
            const r = item.row; const mgr = (r.getCell(COL.MGR).value || "").toString().trim();
            if(targetNames.includes(mgr)) {
                let fullNum = (r.getCell(COL.NUM).value || "?").toString();
                let shortNum = fullNum.split('-').pop().replace('í˜¸', '');
                item.shortNum = shortNum; item.mgrColor = (targets.find(t => t.name === mgr) || {}).color || '#333'; item.mgrName = mgr;
                
                const lat = parseFloat(r.getCell(COL.LAT).value); const lng = parseFloat(r.getCell(COL.LNG).value);
                const isValidLocation = !isNaN(lat) && !isNaN(lng) && lat > 30 && lng > 120;
                
                if(isValidLocation) {
                    const marker = L.marker([lat, lng], { icon: createMarkerIcon(shortNum, item.mgrColor, item.status) }).addTo(map);
                    marker.on('click', (e) => { highlightRow(item.num); openStatusModal(e, item.num, shortNum); });
                    item.marker = marker; markers.push(marker); bounds.push([lat, lng]); validCount++;
                }
                
                let statusClass = 'status-none'; if(item.status === 'ì–‘í˜¸') statusClass = 'status-good'; else if(item.status === 'ë¶ˆëŸ‰') statusClass = 'status-warn'; else if(item.status === 'ê³ ì¥') statusClass = 'status-fail';
                const tr = document.createElement('tr'); tr.id = `row-${item.num}`;
                if(isValidLocation) tr.style.backgroundColor = getLightColor(item.mgrColor); else tr.classList.add('error-row');
                
                let statusText = item.status; if(item.memo) statusText += " ğŸ’¬";
                tr.innerHTML = `<td><b>${shortNum}</b></td><td onclick="event.stopPropagation()"><button class="badge-status ${statusClass}" onclick="openStatusModal(event, ${item.num}, '${shortNum}')">${statusText}</button></td><td style="color:${item.mgrColor}; font-weight:bold;">${mgr}</td><td>${(r.getCell(COL.ROAD).value || "").toString().replace(/ì „ë¼ë‚¨ë„\s*ë‹´ì–‘êµ°\s*/g, '').trim()}</td><td>${(r.getCell(COL.JIBUN).value || "").toString().replace(/ì „ë¼ë‚¨ë„\s*ë‹´ì–‘êµ°\s*/g, '').trim()}</td><td style="font-size:0.7rem;">${(r.getCell(COL.DETAIL).value || "").toString()}</td><td>${(r.getCell(COL.SIGN).value || "").toString().replace(/ì…ìƒì‹/g, '').trim()}</td><td>${(r.getCell(COL.VALVE).value || "").toString()}</td><td>${(r.getCell(COL.GUARD).value || "").toString()}</td>`;
                tr.onclick = () => { if(isValidLocation) map.setView([lat, lng], 18); highlightRow(item.num); };
                tbody.appendChild(tr);
            }
        });
        document.getElementById('count-badge').innerText = `${validCount}ê±´ í‘œì‹œ`;
        if(bounds.length > 0) map.fitBounds(bounds); 
    }

    function highlightRow(id) {
        document.querySelectorAll('.selected-row').forEach(e => e.classList.remove('selected-row'));
        const row = document.getElementById(`row-${id}`); if(row) { row.classList.add('selected-row'); row.scrollIntoView({behavior:'smooth', block:'nearest'}); }
    }

    function updateModalHeaderColor(status) {
        const header = document.getElementById('modal-shortNum');
        if (status === 'ì–‘í˜¸') { header.style.backgroundColor = 'rgba(39, 174, 96, 0.15)'; header.style.color = '#27ae60'; } 
        else if (status === 'ë¶ˆëŸ‰') { header.style.backgroundColor = 'rgba(243, 156, 18, 0.15)'; header.style.color = '#d35400'; } 
        else if (status === 'ê³ ì¥') { header.style.backgroundColor = 'rgba(231, 76, 60, 0.15)'; header.style.color = '#c0392b'; } 
        else { header.style.backgroundColor = 'transparent'; header.style.color = '#2c3e50'; }
    }

    function openStatusModal(e, rowNum, shortNum) {
        if(e && typeof e.stopPropagation === 'function') e.stopPropagation();
        currentEditItem = loadedRows.find(item => item.num === rowNum);
        const r = currentEditItem.row;
        document.getElementById('modal-shortNum').innerText = `[${shortNum}ë²ˆ] ì •ë³´ ë° ì ê²€`;
        updateModalHeaderColor(currentEditItem.status); 
        document.getElementById('modal-mgr').innerText = currentEditItem.mgrName; 
        document.getElementById('modal-road').innerText = (r.getCell(COL.ROAD).value || "").toString().replace(/ì „ë¼ë‚¨ë„\s*ë‹´ì–‘êµ°\s*/g, '').trim() || '-';
        document.getElementById('modal-jibun').innerText = (r.getCell(COL.JIBUN).value || "").toString().replace(/ì „ë¼ë‚¨ë„\s*ë‹´ì–‘êµ°\s*/g, '').trim() || '-';
        document.getElementById('modal-detail').innerText = (r.getCell(COL.DETAIL).value || "").toString() || '-';
        document.getElementById('modal-sign').innerText = (r.getCell(COL.SIGN).value || "").toString().replace(/ì…ìƒì‹/g, '').trim() || '-';
        document.getElementById('modal-valve').innerText = (r.getCell(COL.VALVE).value || "").toString() || '-';
        document.getElementById('modal-guard').innerText = (r.getCell(COL.GUARD).value || "").toString() || '-';
        document.getElementById('modal-memo').innerText = currentEditItem.memo || '-';

        document.getElementById('default-info-area').style.display = 'block';
        document.getElementById('photo-editor-area').style.display = 'none';
        clearCanvas();
        document.getElementById('status-overlay').style.display = 'flex';
    }

    function closeStatusModal() { document.getElementById('status-overlay').style.display = 'none'; currentEditItem = null; }
    
    function saveStatus(newStatus) {
        if(currentEditItem) {
            let memo = "";
            if(newStatus === 'ë¶ˆëŸ‰' || newStatus === 'ê³ ì¥') {
                memo = prompt(`[${newStatus}] ìƒíƒœë¥¼ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤.\nê°„ë‹¨í•œ ì‚¬ìœ (ë©”ëª¨)ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”:`, currentEditItem.memo || "");
                if(memo === null) return; 
            }
            currentEditItem.status = newStatus; currentEditItem.memo = memo;
            const rowBtn = document.querySelector(`#row-${currentEditItem.num} .badge-status`);
            if(rowBtn) { 
                let statusClass = 'status-none'; 
                if(newStatus === 'ì–‘í˜¸') statusClass = 'status-good'; else if(newStatus === 'ë¶ˆëŸ‰') statusClass = 'status-warn'; else if(newStatus === 'ê³ ì¥') statusClass = 'status-fail'; 
                rowBtn.innerText = newStatus + (memo ? " ğŸ’¬" : ""); rowBtn.className = `badge-status ${statusClass}`;
            }
            if(currentEditItem.marker) currentEditItem.marker.setIcon(createMarkerIcon(currentEditItem.shortNum, currentEditItem.mgrColor, newStatus)); 
            
            fetch(API_URL + '/update', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ room_id: currentRoomId, id: currentEditItem.num, status: newStatus, memo: memo, manager: currentEditItem.mgrName })
            }).catch(e => console.log(e));
            closeStatusModal(); 
        }
    }

    async function setAllGood() {
        if(!confirm("í˜„ì¬ ëª©ë¡ì— ìˆëŠ” ëª¨ë“  'ë¯¸ì ê²€' ìš©ìˆ˜ë¥¼ 'ì–‘í˜¸'ë¡œ ì¼ê´„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        document.getElementById('loading-msg').innerText = "ì¼ê´„ ì–‘í˜¸ ì²˜ë¦¬ ì¤‘..."; document.getElementById('loading').style.display = 'flex';
        const targets = loadedRows.filter(item => document.getElementById(`row-${item.num}`) && item.status !== 'ì–‘í˜¸');
        for(let item of targets) {
            item.status = 'ì–‘í˜¸'; item.memo = '';
            const rowBtn = document.querySelector(`#row-${item.num} .badge-status`);
            if(rowBtn) { rowBtn.innerText = 'ì–‘í˜¸'; rowBtn.className = 'badge-status status-good'; }
            if(item.marker) item.marker.setIcon(createMarkerIcon(item.shortNum, item.mgrColor, 'ì–‘í˜¸'));
            await fetch(API_URL + '/update', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ room_id: currentRoomId, id: item.num, status: 'ì–‘í˜¸', memo: '', manager: item.mgrName })
            }).catch(e => console.log(e));
        }
        document.getElementById('loading').style.display = 'none';
        alert(`ì´ ${targets.length}ê±´ì´ ì¼ê´„ ì–‘í˜¸ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤!`);
    }

    const canvas = document.getElementById('photo-canvas'); const ctx = canvas.getContext('2d'); const cameraInput = document.getElementById('cameraInput'); let originalImage = null;
    function triggerCamera() { cameraInput.click(); }
    cameraInput.addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
            document.getElementById('loading-msg').innerText = "ì‚¬ì§„ ìµœì í™” ì¤‘..."; document.getElementById('loading').style.display = 'flex';
            const reader = new FileReader();
            reader.onload = function(event) {
                originalImage = new Image();
                originalImage.onload = function() {
                    drawBaseImageWithOverlay();
                    document.getElementById('default-info-area').style.display = 'none';
                    document.getElementById('photo-editor-area').style.display = 'block';
                    document.getElementById('loading').style.display = 'none';
                }
                originalImage.src = event.target.result;
            }
            reader.readAsDataURL(e.target.files[0]);
        }
    });

    function drawBaseImageWithOverlay() {
        const maxWidth = 600; const scale = maxWidth / originalImage.width; canvas.width = maxWidth; canvas.height = originalImage.height * scale;
        ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);
        const overlayHeight = 40; ctx.fillStyle = 'rgba(0, 0, 0, 0.6)'; ctx.fillRect(0, canvas.height - overlayHeight, canvas.width, overlayHeight);
        ctx.fillStyle = 'white'; ctx.font = 'bold 20px "Malgun Gothic", sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText(`[${currentEditItem.shortNum}ë²ˆ ìš©ìˆ˜] ë‹´ë‹¹: ${currentEditItem.mgrName}`, canvas.width / 2, canvas.height - (overlayHeight / 2));
    }

    canvas.addEventListener('click', function(e) {
        ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height); drawBaseImageWithOverlay(); 
        const rect = canvas.getBoundingClientRect(); const x = (e.clientX - rect.left) * (canvas.width / rect.width); const y = (e.clientY - rect.top) * (canvas.height / rect.height);
        ctx.beginPath(); ctx.arc(x, y, 30, 0, 2 * Math.PI); ctx.lineWidth = 4; ctx.strokeStyle = '#f1c40f'; ctx.stroke(); ctx.fillStyle = 'rgba(241, 196, 15, 0.3)'; ctx.fill();
    });

    function saveEditedPhoto() {
        if (!currentEditItem) return;
        const fileName = `${currentEditItem.shortNum}ë²ˆìš©ìˆ˜-${currentEditItem.mgrName}.jpg`;
        const compressedBase64 = canvas.toDataURL('image/jpeg', 0.6); 
        currentEditItem.photoBase64 = compressedBase64;
        
        const link = document.createElement('a'); link.download = fileName; link.href = compressedBase64; link.click();
        alert("ì‚¬ì§„ì´ ê¸°ê¸°ì— ì €ì¥ë˜ì—ˆê³ , ë‚˜ì¤‘ì— ì´ë©”ì¼ ë°œì†¡ ì‹œ í•¨ê»˜ ì²¨ë¶€ë©ë‹ˆë‹¤!");
        closeStatusModal(); 
    }

    function cancelPhotoEdit() { clearCanvas(); document.getElementById('photo-editor-area').style.display = 'none'; document.getElementById('default-info-area').style.display = 'block'; cameraInput.value = ''; }
    function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); originalImage = null; }

    // âœ¨âœ¨âœ¨ ì´ˆê¸°í™” ì‹œ ì„œë²„ ë°ì´í„°ê¹Œì§€ ì™„ë²½ í¬ë§·í•˜ëŠ” ë¡œì§ ì¶”ê°€ âœ¨âœ¨âœ¨
    async function resetWork() { 
        if(!confirm("âš ï¸ ê²½ê³ : ì´ˆê¸°í™”í•˜ì‹œë©´ 'ì„œë²„ì— ì €ì¥ëœ í˜„ì¬ ì—‘ì…€ íŒŒì¼ì˜ ì‘ì—… ê¸°ë¡'ê¹Œì§€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; 
        
        if (loadedRows.length > 0) {
            document.getElementById('loading-msg').innerText = "ì„œë²„ ë°ì´í„° ì™„ì „ ì´ˆê¸°í™” ì¤‘..."; 
            document.getElementById('loading').style.display = 'flex';
            
            // ì„œë²„ì— ë®ì–´ì“°ê¸° ìš”ì²­ì„ ë³‘ë ¬ë¡œ ë³´ë‚´ì„œ ì‚­ì œ ì²˜ë¦¬ (ë¯¸ì ê²€ ìƒíƒœë¡œ ë¡¤ë°±)
            const resetPromises = loadedRows.map(item => {
                if(item.status !== 'ë¯¸ì ê²€' || item.memo !== '') {
                    return fetch(API_URL + '/update', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ room_id: currentRoomId, id: item.num, status: 'ë¯¸ì ê²€', memo: '', manager: item.mgrName })
                    }).catch(e => console.log(e));
                }
            });
            await Promise.all(resetPromises);
        }

        if(syncInterval) clearInterval(syncInterval); 
        document.getElementById('sync-indicator').style.display = 'none';
        document.getElementById('header-filename-area').style.display = 'none';
        document.getElementById('header-filename').innerText = '';
        document.getElementById('drop-zone').classList.remove('loaded');
        
        workbook = null; worksheet = null; loadedRows = []; currentEditItem = null; currentRoomId = "default_room";
        markers.forEach(m => map.removeLayer(m)); markers = []; 
        document.getElementById('listBody').innerHTML = '<tr><td colspan="9" style="padding:40px; color:#aaa; text-align:center;">ì—‘ì…€ íŒŒì¼ì„ ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>'; 
        document.getElementById('count-badge').innerText = '0ê±´'; 
        document.getElementById('excelFile').value = ''; 
        map.setView([35.32, 126.98], 11);
        document.getElementById('loading').style.display = 'none';
        alert("ì„œë²„ì™€ ìŠ¤ë§ˆíŠ¸í°ì˜ ëª¨ë“  ë°ì´í„°ê°€ ì™„ë²½í•˜ê²Œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!");
    }

    async function exportExcel() {
        if(loadedRows.length === 0) return alert("ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        document.getElementById('loading-msg').innerText = "ì—‘ì…€ ìƒì„± ì¤‘..."; document.getElementById('loading').style.display = 'flex';
        try {
            const newWb = new ExcelJS.Workbook(); const newWs = newWb.addWorksheet('ì ê²€ê²°ê³¼');
            newWs.addRow(['ì—°ë²ˆ', 'ë²ˆí˜¸', 'ì ê²€ìƒíƒœ', 'íŠ¹ì´ì‚¬í•­', 'ë‹´ë‹¹ì', 'ë„ë¡œëª…', 'ì§€ë²ˆ', 'ìƒì„¸ìœ„ì¹˜', 'í‘œì§€', 'ì œìˆ˜', 'ë³´í˜¸']); 
            newWs.getRow(1).font = { bold: true }; newWs.getRow(1).alignment = { horizontal: 'center' };
            const targetNames = Array.from(document.querySelectorAll('.mgr-check:checked')).map(c => c.value);
            let count = 1;
            loadedRows.forEach(item => {
                const r = item.row; const mgr = (r.getCell(COL.MGR).value || "").toString().trim();
                if(targetNames.includes(mgr) || targetNames.length === 0) {
                    let fullNum = (r.getCell(COL.NUM).value || "").toString(); let road = (r.getCell(COL.ROAD).value || "").toString(); let jibun = (r.getCell(COL.JIBUN).value || "").toString(); let detail = (r.getCell(COL.DETAIL).value || "").toString(); let sign = (r.getCell(COL.SIGN).value || "").toString(); let valve = (r.getCell(COL.VALVE).value || "").toString(); let guard = (r.getCell(COL.GUARD).value || "").toString();
                    newWs.addRow([count++, fullNum, item.status, item.memo || "", mgr, road, jibun, detail, sign, valve, guard]);
                }
            });
            newWs.columns = [{ width: 6 }, { width: 15 }, { width: 10 }, { width: 25 }, { width: 10 }, { width: 25 }, { width: 25 }, { width: 30 }, { width: 10 }, { width: 10 }, { width: 10 }];
            const buffer = await newWb.xlsx.writeBuffer(); const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); const today = new Date().toISOString().slice(2,10).replace(/-/g,''); link.download = `ì†Œë°©ìš©ìˆ˜_ì‹¤ì‹œê°„ì €ì¥ë³¸_${today}.xlsx`; link.click(); 
        } catch(err) { alert("ì—‘ì…€ ìƒì„± ì˜¤ë¥˜: " + err.message); } finally { document.getElementById('loading').style.display = 'none'; }
    }

    async function sendReportEmail() {
        if(loadedRows.length === 0) return alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì—‘ì…€ íŒŒì¼ì„ ë¨¼ì € ë¡œë“œí•˜ì„¸ìš”.");
        
        let savedEmail = localStorage.getItem("myKoreaEmail") || "";
        let targetEmail = prompt("ë³´ê³ ì„œë¥¼ ë°›ì„ ê³µì§ì ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”:", savedEmail);
        if(!targetEmail) return;
        localStorage.setItem("myKoreaEmail", targetEmail);

        document.getElementById('loading-msg').innerText = "ë³´ê³ ì„œ ì••ì¶• ë° ì „ì†¡ ì¤‘...\n(ì‚¬ì§„ ê°¯ìˆ˜ì— ë”°ë¼ ìµœëŒ€ 1~2ë¶„ ì†Œìš”)"; 
        document.getElementById('loading').style.display = 'flex';
        
        try {
            const newWb = new ExcelJS.Workbook(); const newWs = newWb.addWorksheet('ì ê²€ê²°ê³¼');
            newWs.addRow(['ì—°ë²ˆ', 'ë²ˆí˜¸', 'ì ê²€ìƒíƒœ', 'íŠ¹ì´ì‚¬í•­', 'ë‹´ë‹¹ì', 'ë„ë¡œëª…', 'ì§€ë²ˆ', 'ìƒì„¸ìœ„ì¹˜']); 
            newWs.getRow(1).font = { bold: true };
            let count = 1;
            loadedRows.forEach(item => {
                const r = item.row; const mgr = (r.getCell(COL.MGR).value || "").toString().trim();
                newWs.addRow([count++, (r.getCell(COL.NUM).value || "").toString(), item.status, item.memo || "", mgr, (r.getCell(COL.ROAD).value || "").toString(), (r.getCell(COL.JIBUN).value || "").toString(), (r.getCell(COL.DETAIL).value || "").toString()]);
            });
            const buffer = await newWb.xlsx.writeBuffer();
            const excelBase64 = btoa(new Uint8Array(buffer).reduce((data, byte) => data + String.fromCharCode(byte), ''));

            let attachedPhotos = [];
            loadedRows.forEach(item => {
                if(item.photoBase64) {
                    attachedPhotos.push({
                        filename: `${item.shortNum}ë²ˆìš©ìˆ˜_${item.mgrName}.jpg`,
                        data: item.photoBase64
                    });
                }
            });

            const res = await fetch(API_URL + '/send_email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    target_email: targetEmail,
                    excel_b64: excelBase64,
                    photos: attachedPhotos
                })
            });
            
            const result = await res.json();
            if(result.result === 'success') {
                alert(`ì„±ê³µ! [${targetEmail}]ë¡œ ì—‘ì…€ íŒŒì¼ê³¼ ì‚¬ì§„(${attachedPhotos.length}ì¥)ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            } else {
                alert("ì „ì†¡ ì‹¤íŒ¨: " + result.message);
            }
        } catch(err) { 
            alert("ì „ì†¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message); 
        } finally { 
            document.getElementById('loading').style.display = 'none'; 
        }
    }

    let gpsWatchId = null; let userMarker = null; 
    function toggleGPS() {
        const btn = document.getElementById('gps-btn');
        if (gpsWatchId) { navigator.geolocation.clearWatch(gpsWatchId); gpsWatchId = null; if (userMarker) { map.removeLayer(userMarker); userMarker = null; } btn.innerText = "ğŸ¯ ë‚´ ìœ„ì¹˜ í‘œì‹œ"; btn.classList.remove('active'); return; }
        if (!navigator.geolocation) return alert("ìŠ¤ë§ˆíŠ¸í°ì˜ ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì¼œì£¼ì„¸ìš”.");
        btn.innerText = "â¹ï¸ ìœ„ì¹˜ í‘œì‹œ ë„ê¸°"; btn.classList.add('active');
        gpsWatchId = navigator.geolocation.watchPosition(
            (position) => {
                const latlng = [position.coords.latitude, position.coords.longitude];
                if (!userMarker) { userMarker = L.circleMarker(latlng, { color: '#3498db', radius: 8, fillOpacity: 1, border: '2px solid white' }).addTo(map); map.setView(latlng, 17); } 
                else { userMarker.setLatLng(latlng); }
            },
            (error) => { alert("GPS ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); toggleGPS(); }, { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
        );
    }
</script>
</body>
</html>
