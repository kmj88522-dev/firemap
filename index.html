<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ğŸš’ ì†Œë°©ìš©ìˆ˜ í†µí•©ê´€ì œ v81</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<style>
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; font-family: 'Malgun Gothic', sans-serif; width: 100vw; height: 100vh; height: 100dvh; position: fixed; top: 0; left: 0; display: flex; flex-direction: column; overflow: hidden; background-color: #f4f6f9; }
    #header { height:40px; background:#2c3e50; color:white; display:flex; align-items:center; padding:0 15px; border-bottom:3px solid #ff9f43; flex-shrink: 0; z-index: 5000; position: relative; }
    @keyframes blink { 0% { opacity:1; } 50% { opacity:0.3; } 100% { opacity:1; } }
    .sync-badge { font-size:0.7rem; background:#27ae60; padding:3px 8px; border-radius:12px; margin-left:10px; font-weight:bold; animation: blink 2s infinite; box-shadow: 0 0 5px #27ae60; }
    #container { display:flex; flex:1; height:calc(100vh - 40px); height:calc(100dvh - 40px); position:relative; width: 100%; overflow: hidden; }
    #left-panel { width:240px; background:white; border-right:1px solid #ccc; display:flex; flex-direction:column; padding:10px; z-index:1000; flex-shrink: 0; gap: 8px;}
    #drop-zone { border: 2px dashed #bdc3c7; border-radius: 6px; background: #fafafa; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: #7f8c8d; cursor: pointer; transition: all 0.3s ease; padding: 15px 5px; min-height: 100px; }
    #drop-zone:hover, #drop-zone.dragover { background: #e0f7fa; border-color: #00bcd4; color: #00838f; }
    #drop-zone .icon { font-size: 2rem; margin-bottom: 5px; }
    #file-status { font-size: 0.85rem; font-weight: bold; line-height: 1.3; word-break: break-all;}
    #map-wrapper { flex:1; position: relative; z-index: 1; min-height: 250px; }
    #map { position: absolute; top: 0; left: 0; right: 0; bottom: 0; }
    #right-panel { width:45%; min-width:350px; background:white; border-left:1px solid #ccc; display:flex; flex-direction:column; z-index:1000; flex-shrink: 0; position: relative; overflow: hidden; }
    .overlay { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; display:none; justify-content:center; align-items:center; }
    .modal { background:white; width:95%; max-width:380px; padding:20px; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,0.5); border-top:5px solid #2980b9; max-height: 90vh; overflow-y: auto; }
    #status-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; background: #ffffff; z-index: 2000; display: none; flex-direction: column; padding: 10px 15px; overflow-y: auto; box-sizing: border-box; }
    #overlay-list { display:grid; grid-template-columns:1fr 1fr; gap:8px; max-height:250px; overflow-y:auto; margin:15px 0; border:1px solid #eee; padding:10px; background:#f9f9f9;}
    .mgr-label { cursor:pointer; display:flex; align-items:center; font-size:0.9rem; padding:6px; border-radius:4px; background:white; border:1px solid #ddd;}
    .btn-blue { width:100%; padding:8px; background:#2980b9; color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer; font-size:0.9rem;}
    .btn-gray { width:100%; padding:8px; background:#95a5a6; color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer; font-size:0.9rem; margin-top:5px;}
    .btn-green { width:100%; padding:10px; background:#27ae60; color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer; font-size:0.9rem;}
    #modal-shortNum { transition: background 0.3s ease, color 0.3s ease; border-radius: 5px; }
    .modal-info-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; text-align: left; margin-bottom: 8px; line-height: 1.2; }
    .modal-info-table th { background: #f1f2f6; padding: 4px 6px; border: 1px solid #ddd; color: #333; width: 25%; white-space: nowrap; }
    .modal-info-table td { padding: 4px 6px; border: 1px solid #ddd; color: #2c3e50; font-weight: bold; word-break: break-all;}
    .status-btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 5px; }
    .status-select-btn { padding: 8px 5px; border:none; border-radius:5px; color:white; font-weight:bold; cursor:pointer; font-size:0.85rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .badge-status { padding: 3px 0; border-radius: 3px; font-size: 0.7rem; font-weight: bold; color: white; cursor: pointer; border: none; width: 90%; margin: 0 auto; display: block; line-height: 1.2; box-shadow: 0 1px 2px rgba(0,0,0,0.2); transition: all 0.3s ease;}
    .status-none { background: #95a5a6; } .status-good { background: #27ae60; } .status-warn { background: #f39c12; } .status-fail { background: #e74c3c; } 
    .info-table { width:100%; border-collapse:collapse; font-size:0.75rem; table-layout:fixed; }
    .info-table th { background:#34495e; color:white; padding:6px 2px; position:sticky; top:0; z-index:10; white-space:nowrap; font-size: 0.75rem; position:relative; }
    .info-table td { border-bottom:1px solid #ddd; padding: 4px 2px; text-align:center; word-break:keep-all; vertical-align:middle; line-height:1.1; overflow:hidden; text-overflow:ellipsis; transition: background 0.3s; }
    .info-table tr:hover { filter: brightness(0.95); cursor:pointer; }
    .selected-row { border-left:4px solid #e67e22; font-weight:bold; filter: brightness(0.9); }
    .error-row { background:#ffebee !important; color:#c0392b; }
    .circle-marker { display:flex; justify-content:center; align-items:center; border-radius:50%; font-weight:900; font-family:'Arial Black', sans-serif; box-shadow:0 3px 6px rgba(0,0,0,0.4); transition:transform 0.3s ease, background 0.3s ease, color 0.3s ease; }
    .circle-marker:hover { transform: scale(1.1); }
    #gps-btn { position: absolute; bottom: 20px; right: 20px; z-index: 2000; background: white; border: 2px solid #2980b9; color: #2980b9; border-radius: 50px; padding: 10px 15px; font-weight: bold; font-size: 0.85rem; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: all 0.3s ease; }
    #gps-btn.active { background: #e74c3c; color: white; border-color: #c0392b; }
    #loading { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; display:none; justify-content:center; align-items:center; color:white; flex-direction:column; font-size:1.2rem; }
    .spinner { width:50px; height:50px; border:5px solid #f3f3f3; border-top:5px solid #e67e22; border-radius:50%; animation:spin 1s linear infinite; margin-bottom:15px; }
    @keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
    #photo-canvas-container { width: 100%; overflow: hidden; margin-top: 10px; border: 2px solid #ddd; display: none; touch-action: none; }
    #photo-canvas { width: 100%; height: auto; display: block; cursor: crosshair; }
    @media (max-width: 768px) {
        #container { flex-direction: column; overflow: hidden; height: calc(100dvh - 40px); }
        #left-panel { flex-direction: row; width: 100%; height: auto; padding: 5px; border-right: none; border-bottom: 2px solid #2980b9; gap: 5px; align-items: center; z-index: 100;}
        #drop-zone { flex: 1; padding: 5px; min-height: 40px; flex-direction: row; gap: 10px; margin: 0; }
        #drop-zone .icon { font-size: 1.5rem; margin: 0; }
        #file-status { font-size: 0.8rem; text-align: left; }
        .action-btns { display: flex; flex-direction: column; gap: 3px; width: 120px; }
        .action-btns button { padding: 5px; font-size: 0.75rem; margin: 0; }
        #map-wrapper { flex: 1; min-height: 40vh; width: 100%; z-index: 1; }
        #right-panel { height: 42vh; width: 100%; border-left: none; border-top: 2px solid #34495e; position: relative; overflow: hidden; z-index: 10; }
    }
</style>
</head>
<body>

<div id="loading"><div class="spinner"></div><div id="loading-msg">ì²˜ë¦¬ ì¤‘...</div></div>
<input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;">

<div id="manager-overlay" class="overlay">
    <div class="modal">
        <h3 style="margin-top:0; color:#2c3e50;">ğŸ‘¤ ë‹´ë‹¹ì ì„ íƒ (ìµœëŒ€ 3ëª…)</h3>
        <div id="overlay-list"></div>
        <div style="display:flex; flex-direction:column; gap:5px;">
            <button class="btn-blue" onclick="confirmManager()">âœ… í™•ì¸</button>
            <div style="display:flex; gap:5px;">
                <button class="btn-gray" style="flex:1; background:#7f8c8d;" onclick="resetManagerSelection()">ğŸ”„ ì„ íƒ ì´ˆê¸°í™”</button>
                <button class="btn-gray" style="flex:1;" onclick="document.getElementById('manager-overlay').style.display='none'">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<div id="header">
    <h3 style="margin:0; font-size:1.1rem; display:flex; align-items:center;">
        ğŸš’ ì†Œë°©ìš©ìˆ˜ í†µí•©ê´€ì œ 
        <span class="sync-badge" id="sync-indicator" style="display:none;">ğŸ“¡ ë¼ì´ë¸Œ ë™ê¸°í™” ì¤‘</span>
    </h3>
</div>

<div id="container">
    <div id="left-panel">
        <label id="drop-zone" for="excelFile">
            <div class="icon">ğŸ“‚</div>
            <div id="file-status">íŒŒì¼ì„ í„°ì¹˜í•˜ê±°ë‚˜<br>ë“œë˜ê·¸í•˜ì„¸ìš”</div>
            <input type="file" id="excelFile" accept=".xlsx" style="display:none;" />
        </label>
        <div class="action-btns">
            <button class="btn-green" onclick="exportExcel()">ğŸ’¾ ì—‘ì…€ íŒŒì¼ ì¶”ì¶œ</button>
            <button class="btn-gray" onclick="resetWork()">ğŸ”„ ë°ì´í„° ì´ˆê¸°í™”</button>
        </div>
    </div>

    <div id="map-wrapper">
        <div id="map"></div>
        <button id="gps-btn" onclick="toggleGPS()">ğŸ¯ ë‚´ ìœ„ì¹˜ í‘œì‹œ</button>
    </div>

    <div id="right-panel">
        <div style="padding:4px 10px; background:#34495e; color:white; display:flex; justify-content:space-between; align-items:center;">
            <div style="display:flex; align-items:center; gap: 8px;">
                <span style="font-size:0.85rem; font-weight:bold;">ğŸ“‹ ìš©ìˆ˜ ëª©ë¡</span>
                <button onclick="setAllGood()" style="background:#27ae60; color:white; border:1px solid #2ecc71; border-radius:4px; padding:3px 8px; font-size:0.75rem; font-weight:bold; cursor:pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.3);">ì¼ê´„ ì–‘í˜¸ âœ…</button>
            </div>
            <span id="count-badge" style="background:#e67e22; padding:2px 8px; border-radius:12px; font-size:0.75rem; font-weight:bold;">0ê±´</span>
        </div>
        <div style="overflow:auto; flex:1;">
            <table class="info-table">
                <thead>
                    <tr>
                        <th style="width:8%;">ë²ˆí˜¸</th><th style="width:12%;">ìƒíƒœ</th><th style="width:10%;">ë‹´ë‹¹</th><th style="width:18%;">ë„ë¡œëª…</th><th style="width:14%;">ì§€ë²ˆ</th><th style="width:22%;">ìƒì„¸</th><th style="width:6%;">í‘œì§€</th><th style="width:5%;">ì œìˆ˜</th><th style="width:5%;">ë³´í˜¸</th>
                    </tr>
                </thead>
                <tbody id="listBody"><tr><td colspan="9" style="padding:30px; color:#aaa; text-align:center;">ì—‘ì…€ íŒŒì¼ì„ ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr></tbody>
            </table>
        </div>

        <div id="status-overlay">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 2px solid #ff9f43; padding-bottom: 3px; margin-bottom: 8px;">
                <h3 id="modal-shortNum" style="margin:0; font-size:0.95rem; padding: 4px 8px;">ğŸ“‹ ìƒì„¸ì •ë³´ ë° ì ê²€</h3>
                <button onclick="closeStatusModal()" style="background:none; border:none; font-size:1.1rem; cursor:pointer; padding-right:5px;">âŒ</button>
            </div>
            
            <div id="default-info-area">
                <table class="modal-info-table">
                    <tr><th>ë‹´ë‹¹ì</th><td id="modal-mgr"></td></tr>
                    <tr><th>ìœ„ì¹˜</th><td><span id="modal-road"></span><br><span id="modal-jibun" style="font-size:0.7rem; color:#7f8c8d;"></span></td></tr>
                    <tr><th>ìƒì„¸/ì‹œì„¤</th><td><span id="modal-detail"></span><br><span style="font-size:0.7rem; color:#7f8c8d;">(í‘œì§€:<span id="modal-sign"></span> ì œìˆ˜:<span id="modal-valve"></span> ë³´í˜¸:<span id="modal-guard"></span>)</span></td></tr>
                    <tr><th>íŠ¹ì´ì‚¬í•­</th><td id="modal-memo" style="color:#e74c3c;">-</td></tr>
                </table>
                <div class="status-btn-grid">
                    <button class="status-select-btn" style="background:#27ae60;" onclick="saveStatus('ì–‘í˜¸')">ğŸŸ¢ ì–‘í˜¸</button>
                    <button class="status-select-btn" style="background:#f39c12;" onclick="saveStatus('ë¶ˆëŸ‰')">ğŸŸ  ë¶ˆëŸ‰</button>
                    <button class="status-select-btn" style="background:#e74c3c;" onclick="saveStatus('ê³ ì¥')">ğŸ”´ ê³ ì¥</button>
                    <button class="status-select-btn" style="background:#95a5a6;" onclick="saveStatus('ë¯¸ì ê²€')">âšª ì´ˆê¸°í™”</button>
                </div>
                <button class="btn-blue" style="margin-top:2px; background:#3498db;" onclick="triggerCamera()">ğŸ“· í˜„ì¥ ì‚¬ì§„ ì´¬ì˜ ë° í‘œì‹œ</button>
            </div>

            <div id="photo-editor-area" style="display:none;">
                <p style="font-size:0.75rem; color:#e67e22; margin: 2px 0; font-weight:bold;">ğŸ’¡ ì‚¬ì§„ ì† ì œìˆ˜ë³€ ìœ„ì¹˜ë¥¼ í„°ì¹˜í•˜ì—¬ í‘œì‹œí•˜ì„¸ìš”.</p>
                <div id="photo-canvas-container">
                    <canvas id="photo-canvas"></canvas>
                </div>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <button class="btn-green" style="flex:1;" onclick="saveEditedPhoto()">ğŸ’¾ ì‚¬ì§„ ì €ì¥</button>
                    <button class="btn-gray" style="flex:1; background:#e74c3c;" onclick="cancelPhotoEdit()">âŒ ì·¨ì†Œ</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
        window.addEventListener(evt, e => e.preventDefault(), { capture: true });
        document.addEventListener(evt, e => e.preventDefault(), { capture: true });
    });

    const API_URL = "https://koreanparamedics.pythonanywhere.com";
    const COL = { NUM: 7, ROAD: 9, JIBUN: 10, DETAIL: 11, LAT: 12, LNG: 13, SIGN: 18, VALVE: 20, GUARD: 21, MGR: 27 };
    const ACTIVE_COLORS = ['#ff4757', '#2ed573', '#1e90ff']; 

    let map, markers=[], workbook=null, worksheet=null, loadedRows=[];
    let currentEditItem = null; 
    let syncInterval = null; 
    
    // âœ¨ ìš©ëŸ‰ì„ ì§€ìš°ê³  ì˜¤ì§ íŒŒì¼ ì´ë¦„ë§Œ ê°€ì ¸ì™€ì„œ ì±„íŒ…ë°© ì•„ì´ë””ë¡œ ì”ë‹ˆë‹¤!
    let currentRoomId = "default_room"; 

    map = L.map('map', { zoomControl: false }).setView([35.32, 126.98], 11);
    L.control.zoom({ position: 'bottomleft' }).addTo(map); 
    
    const vworldBase = L.tileLayer('https://xdworld.vworld.kr/2d/Base/service/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'Â© Vworld' });
    const vworldSatellite = L.tileLayer('https://xdworld.vworld.kr/2d/Satellite/service/{z}/{x}/{y}.jpeg', { maxZoom: 19, attribution: 'Â© Vworld' });
    const vworldHybrid = L.tileLayer('https://xdworld.vworld.kr/2d/Hybrid/service/{z}/{x}/{y}.png', { maxZoom: 19 });
    const osmBase = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'Â© OSM' });

    vworldBase.addTo(map);
    const hybridGroup = L.layerGroup([vworldSatellite, vworldHybrid]);
    const baseMaps = { "ğŸ—ºï¸ ì¼ë°˜ ì§€ë„": vworldBase, "ğŸ›°ï¸ ìœ„ì„±+ì§€ëª…": hybridGroup, "âš¡ ì˜ˆë¹„ìš©": osmBase };
    L.control.layers(baseMaps).addTo(map);

    function getLightColor(hexColor) {
        if(!hexColor || hexColor.length < 7) return 'rgba(255, 255, 255, 0)';
        let r = parseInt(hexColor.slice(1, 3), 16), g = parseInt(hexColor.slice(3, 5), 16), b = parseInt(hexColor.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, 0.12)`; 
    }

    function createMarkerIcon(shortNum, mgrColor, status) {
        let textColor = '#ffffff'; 
        if (status === 'ì–‘í˜¸') textColor = '#2ecc71'; 
        if (status === 'ë¶ˆëŸ‰') textColor = '#f1c40f'; 
        if (status === 'ê³ ì¥') textColor = '#ff4757'; 
        return L.divIcon({ className:'', html: `<div class="circle-marker" style="background:#1e272e; color:${textColor}; border:3px solid ${mgrColor}; width:26px; height:26px; font-size:11px; letter-spacing:-0.5px;">${shortNum}</div>`, iconSize:[26,26], iconAnchor:[13,13] });
    }

    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('excelFile');
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => dropZone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); }));
    dropZone.addEventListener('dragover', () => dropZone.classList.add('dragover'));
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', e => { dropZone.classList.remove('dragover'); if(e.dataTransfer && e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]); });
    fileInput.addEventListener('change', e => { if(e.target.files.length > 0) handleFile(e.target.files[0]); });

    async function handleFile(file) {
        if(!file) return;
        
        // âœ¨ ì±„íŒ…ë°© ID ìƒì„±: ì˜¤ì§ "íŒŒì¼ ì´ë¦„"ë§Œ ì‚¬ìš©! ìš©ëŸ‰ì´ ë‹¬ë¼ë„ ì´ë¦„ë§Œ ê°™ìœ¼ë©´ ì—°ë™ë¨.
        currentRoomId = file.name;

        document.getElementById('loading-msg').innerText = "íŒŒì¼ ë° í´ë¼ìš°ë“œ ë°ì´í„° ì½ëŠ” ì¤‘...";
        document.getElementById('loading').style.display = 'flex';
        try {
            const buffer = await file.arrayBuffer();
            workbook = new ExcelJS.Workbook();
            await workbook.xlsx.load(buffer);
            worksheet = workbook.worksheets[0];
            loadedRows = [];
            
            worksheet.eachRow((row, rowNumber) => { 
                if(rowNumber >= 3) {
                    loadedRows.push({ row: row, num: rowNumber, status: 'ë¯¸ì ê²€', shortNum: '', mgrColor: '#333', marker: null, mgrName: '', memo: '' }); 
                }
            });
            
            try {
                const res = await fetch(API_URL + '/data?room=' + encodeURIComponent(currentRoomId) + '&t=' + new Date().getTime());
                const serverData = await res.json();
                loadedRows.forEach(item => {
                    const sData = serverData[item.num];
                    if(sData) {
                        item.status = sData.status;
                        item.memo = sData.memo || '';
                    }
                });
            } catch(e) { console.log("ì„œë²„ ì—°ê²° ì‹¤íŒ¨ ë˜ëŠ” ë°©ì´ ë¹„ì–´ìˆìŒ"); }

            document.getElementById('file-status').innerHTML = `<span style="color:#2980b9;">${file.name}</span>`;
            showManagerOverlay();
            startRealtimeSync();

        } catch(err) { alert("ì—‘ì…€ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); } 
        finally { document.getElementById('loading').style.display = 'none'; fileInput.value = ''; }
    }

    function startRealtimeSync() {
        if(syncInterval) clearInterval(syncInterval);
        document.getElementById('sync-indicator').style.display = 'inline-block'; 
        
        syncInterval = setInterval(async () => {
            if(loadedRows.length === 0) return;
            try {
                const res = await fetch(API_URL + '/data?room=' + encodeURIComponent(currentRoomId) + '&t=' + new Date().getTime());
                const serverData = await res.json();
                
                loadedRows.forEach(item => {
                    const sData = serverData[item.num];
                    if(sData) {
                        if(item.status !== sData.status || item.memo !== sData.memo) {
                            item.status = sData.status;
                            item.memo = sData.memo || '';
                            
                            const rowBtn = document.querySelector(`#row-${item.num} .badge-status`);
                            if(rowBtn) {
                                let statusClass = 'status-none'; 
                                if(item.status === 'ì–‘í˜¸') statusClass = 'status-good'; 
                                else if(item.status === 'ë¶ˆëŸ‰') statusClass = 'status-warn'; 
                                else if(item.status === 'ê³ ì¥') statusClass = 'status-fail'; 
                                rowBtn.innerText = item.status + (item.memo ? " ğŸ’¬" : "");
                                rowBtn.className = `badge-status ${statusClass}`;
                            }
                            if(item.marker) { 
                                const newIcon = createMarkerIcon(item.shortNum, item.mgrColor, item.status); 
                                item.marker.setIcon(newIcon); 
                            }
                            if(currentEditItem && currentEditItem.num === item.num) {
                                document.getElementById('modal-memo').innerText = item.memo || '-';
                                updateModalHeaderColor(item.status);
                            }
                        }
                    }
                });
            } catch(e) { console.log("ë™ê¸°í™” ëŒ€ê¸°ì¤‘..."); }
        }, 3000); 
    }

    function showManagerOverlay() {
        const mgrSet = new Set();
        loadedRows.forEach(item => { const val = item.row.getCell(COL.MGR).value; if(val) mgrSet.add(val.toString().trim()); });
        const list = document.getElementById('overlay-list'); list.innerHTML = "";
        [...mgrSet].sort().forEach((mgr) => { const div = document.createElement('div'); div.innerHTML = `<label class="mgr-label"><input type="checkbox" class="mgr-check" value="${mgr}" style="margin-right:8px;">${mgr}</label>`; list.appendChild(div); });
        document.getElementById('manager-overlay').style.display = 'flex';
    }

    function resetManagerSelection() { document.querySelectorAll('.mgr-check').forEach(cb => cb.checked = false); }

    function confirmManager() {
        const checks = document.querySelectorAll('.mgr-check:checked');
        if(checks.length === 0) return alert("ìµœì†Œ 1ëª…ì˜ ë‹´ë‹¹ìë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        if(checks.length > 3) return alert("ë‹´ë‹¹ìëŠ” ìµœëŒ€ 3ëª…ê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        const targets = Array.from(checks).map((c, idx) => ({ name: c.value, color: ACTIVE_COLORS[idx] || '#333' }));
        document.getElementById('manager-overlay').style.display = 'none';
        setTimeout(() => map.invalidateSize(), 300); renderMapAndTable(targets);
    }

    function renderMapAndTable(targets) {
        markers.forEach(m => map.removeLayer(m)); markers = [];
        const tbody = document.getElementById('listBody'); tbody.innerHTML = "";
        const bounds = []; const targetNames = targets.map(t => t.name); let validCount = 0;

        loadedRows.forEach(item => {
            const r = item.row; const mgr = (r.getCell(COL.MGR).value || "").toString().trim();
            if(targetNames.includes(mgr)) {
                let fullNum = (r.getCell(COL.NUM).value || "?").toString();
                let shortNum = fullNum.split('-').pop().replace('í˜¸', '');
                const matchedTarget = targets.find(t => t.name === mgr);
                const mgrColor = matchedTarget ? matchedTarget.color : '#333';
                item.shortNum = shortNum; item.mgrColor = mgrColor; item.mgrName = mgr;
                
                const lat = parseFloat(r.getCell(COL.LAT).value); const lng = parseFloat(r.getCell(COL.LNG).value);
                const isValidLocation = !isNaN(lat) && !isNaN(lng) && lat > 30 && lng > 120;
                let road = (r.getCell(COL.ROAD).value || "").toString().replace(/ì „ë¼ë‚¨ë„\s*ë‹´ì–‘êµ°\s*/g, '').trim();
                let jibun = (r.getCell(COL.JIBUN).value || "").toString().replace(/ì „ë¼ë‚¨ë„\s*ë‹´ì–‘êµ°\s*/g, '').trim();
                let sign = (r.getCell(COL.SIGN).value || "").toString().replace(/ì…ìƒì‹/g, '').trim();
                const detail = (r.getCell(COL.DETAIL).value || "").toString(); const valve = (r.getCell(COL.VALVE).value || "").toString(); const guard = (r.getCell(COL.GUARD).value || "").toString();

                if(isValidLocation) {
                    const icon = createMarkerIcon(shortNum, mgrColor, item.status);
                    const marker = L.marker([lat, lng], { icon: icon }).addTo(map);
                    marker.on('click', (e) => { highlightRow(item.num); openStatusModal(e, item.num, shortNum); });
                    item.marker = marker; markers.push(marker); bounds.push([lat, lng]); validCount++;
                }
                
                let statusClass = 'status-none'; if(item.status === 'ì–‘í˜¸') statusClass = 'status-good'; if(item.status === 'ë¶ˆëŸ‰') statusClass = 'status-warn'; if(item.status === 'ê³ ì¥') statusClass = 'status-fail';
                const tr = document.createElement('tr'); tr.id = `row-${item.num}`;
                if(isValidLocation) tr.style.backgroundColor = getLightColor(mgrColor); else tr.classList.add('error-row');
                
                let statusText = item.status;
                if(item.memo) statusText += " ğŸ’¬";

                tr.innerHTML = `<td><b>${shortNum}</b></td><td onclick="event.stopPropagation()"><button class="badge-status ${statusClass}" onclick="openStatusModal(event, ${item.num}, '${shortNum}')">${statusText}</button></td><td style="color:${mgrColor}; font-weight:bold;">${mgr}</td><td>${road}</td><td>${jibun}</td><td style="font-size:0.7rem;">${detail}</td><td>${sign}</td><td>${valve}</td><td>${guard}</td>`;
                tr.onclick = () => { if(isValidLocation) map.setView([lat, lng], 18); highlightRow(item.num); };
                tbody.appendChild(tr);
            }
        });
        document.getElementById('count-badge').innerText = `${validCount}ê±´ í‘œì‹œ`;
        if(bounds.length > 0) map.fitBounds(bounds); initResizableColumns();
    }

    function highlightRow(id) {
        document.querySelectorAll('.selected-row').forEach(e => e.classList.remove('selected-row'));
        const row = document.getElementById(`row-${id}`); if(row) { row.classList.add('selected-row'); row.scrollIntoView({behavior:'smooth', block:'nearest'}); }
    }

    function updateModalHeaderColor(status) {
        const header = document.getElementById('modal-shortNum');
        if (status === 'ì–‘í˜¸') {
            header.style.backgroundColor = 'rgba(39, 174, 96, 0.15)'; 
            header.style.color = '#27ae60';
        } else if (status === 'ë¶ˆëŸ‰') {
            header.style.backgroundColor = 'rgba(243, 156, 18, 0.15)'; 
            header.style.color = '#d35400';
        } else if (status === 'ê³ ì¥') {
            header.style.backgroundColor = 'rgba(231, 76, 60, 0.15)'; 
            header.style.color = '#c0392b';
        } else {
            header.style.backgroundColor = 'transparent';
            header.style.color = '#2c3e50';
        }
    }

    function openStatusModal(e, rowNum, shortNum) {
        if(e && typeof e.stopPropagation === 'function') e.stopPropagation();
        currentEditItem = loadedRows.find(item => item.num === rowNum);
        const r = currentEditItem.row;
        const mgr = (r.getCell(COL.MGR).value || "").toString().trim();
        const road = (r.getCell(COL.ROAD).value || "").toString().replace(/ì „ë¼ë‚¨ë„\s*ë‹´ì–‘êµ°\s*/g, '').trim() || '-';
        const jibun = (r.getCell(COL.JIBUN).value || "").toString().replace(/ì „ë¼ë‚¨ë„\s*ë‹´ì–‘êµ°\s*/g, '').trim() || '-';
        const detail = (r.getCell(COL.DETAIL).value || "").toString() || '-';
        const sign = (r.getCell(COL.SIGN).value || "").toString().replace(/ì…ìƒì‹/g, '').trim() || '-';
        const valve = (r.getCell(COL.VALVE).value || "").toString() || '-';
        const guard = (r.getCell(COL.GUARD).value || "").toString() || '-';

        document.getElementById('modal-shortNum').innerText = `[${shortNum}ë²ˆ] ì •ë³´ ë° ì ê²€`;
        updateModalHeaderColor(currentEditItem.status); 

        document.getElementById('modal-mgr').innerText = mgr; 
        document.getElementById('modal-road').innerText = road;
        document.getElementById('modal-jibun').innerText = jibun; 
        document.getElementById('modal-detail').innerText = detail;
        document.getElementById('modal-sign').innerText = sign; 
        document.getElementById('modal-valve').innerText = valve; 
        document.getElementById('modal-guard').innerText = guard;
        document.getElementById('modal-memo').innerText = currentEditItem.memo || '-';

        document.getElementById('default-info-area').style.display = 'block';
        document.getElementById('photo-editor-area').style.display = 'none';
        clearCanvas();

        document.getElementById('status-overlay').style.display = 'flex';
    }

    function closeStatusModal() { document.getElementById('status-overlay').style.display = 'none'; currentEditItem = null; }
    
    function saveStatus(newStatus) {
        if(currentEditItem) {
            let memo = "";
            if(newStatus === 'ë¶ˆëŸ‰' || newStatus === 'ê³ ì¥') {
                memo = prompt(`[${newStatus}] ìƒíƒœë¥¼ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤.\nê°„ë‹¨í•œ ì‚¬ìœ (ë©”ëª¨)ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”:`, currentEditItem.memo || "");
                if(memo === null) return; 
            } else {
                memo = ""; 
            }

            currentEditItem.status = newStatus;
            currentEditItem.memo = memo;

            const rowBtn = document.querySelector(`#row-${currentEditItem.num} .badge-status`);
            if(rowBtn) { 
                let statusClass = 'status-none'; 
                if(newStatus === 'ì–‘í˜¸') statusClass = 'status-good'; 
                else if(newStatus === 'ë¶ˆëŸ‰') statusClass = 'status-warn'; 
                else if(newStatus === 'ê³ ì¥') statusClass = 'status-fail'; 
                rowBtn.innerText = newStatus + (memo ? " ğŸ’¬" : "");
                rowBtn.className = `badge-status ${statusClass}`;
            }
            if(currentEditItem.marker) { 
                const newIcon = createMarkerIcon(currentEditItem.shortNum, currentEditItem.mgrColor, newStatus); 
                currentEditItem.marker.setIcon(newIcon); 
            }
            
            fetch(API_URL + '/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    room_id: currentRoomId, 
                    id: currentEditItem.num, 
                    status: newStatus,
                    memo: memo,
                    manager: currentEditItem.mgrName
                })
            }).catch(e => console.log("ì„œë²„ ì „ì†¡ ì‹¤íŒ¨", e));

            closeStatusModal(); 
        }
    }

    async function setAllGood() {
        if(!confirm("í˜„ì¬ ëª©ë¡ì— ìˆëŠ” ëª¨ë“  'ë¯¸ì ê²€' ìš©ìˆ˜ë¥¼ 'ì–‘í˜¸'ë¡œ ì¼ê´„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì´ë¯¸ ë¶ˆëŸ‰/ê³ ì¥ìœ¼ë¡œ ì²´í¬ëœ ìš©ìˆ˜ë„ ì–‘í˜¸ë¡œ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.)")) return;
        
        document.getElementById('loading-msg').innerText = "ì¼ê´„ ì–‘í˜¸ ì²˜ë¦¬ ì¤‘... (ì„œë²„ ì „ì†¡)";
        document.getElementById('loading').style.display = 'flex';
        
        const targets = loadedRows.filter(item => document.getElementById(`row-${item.num}`) && item.status !== 'ì–‘í˜¸');
        
        for(let item of targets) {
            item.status = 'ì–‘í˜¸';
            item.memo = '';
            
            const rowBtn = document.querySelector(`#row-${item.num} .badge-status`);
            if(rowBtn) {
                rowBtn.innerText = 'ì–‘í˜¸';
                rowBtn.className = 'badge-status status-good';
            }
            if(item.marker) {
                item.marker.setIcon(createMarkerIcon(item.shortNum, item.mgrColor, 'ì–‘í˜¸'));
            }
            
            await fetch(API_URL + '/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    room_id: currentRoomId,
                    id: item.num,
                    status: 'ì–‘í˜¸',
                    memo: '',
                    manager: item.mgrName
                })
            }).catch(e => console.log(e));
        }
        
        document.getElementById('loading').style.display = 'none';
        alert(`ì´ ${targets.length}ê±´ì´ ì¼ê´„ ì–‘í˜¸ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤!`);
    }

    const canvas = document.getElementById('photo-canvas'); const ctx = canvas.getContext('2d'); const cameraInput = document.getElementById('cameraInput'); let originalImage = null;
    function triggerCamera() { cameraInput.click(); }
    cameraInput.addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
            document.getElementById('loading-msg').innerText = "ì‚¬ì§„ ë„ìš°ëŠ” ì¤‘..."; document.getElementById('loading').style.display = 'flex';
            const reader = new FileReader();
            reader.onload = function(event) {
                originalImage = new Image();
                originalImage.onload = function() {
                    drawBaseImageWithOverlay();
                    document.getElementById('default-info-area').style.display = 'none';
                    document.getElementById('photo-editor-area').style.display = 'block';
                    document.getElementById('loading').style.display = 'none';
                }
                originalImage.src = event.target.result;
            }
            reader.readAsDataURL(e.target.files[0]);
        }
    });

    function drawBaseImageWithOverlay() {
        const maxWidth = 800; const scale = maxWidth / originalImage.width; canvas.width = maxWidth; canvas.height = originalImage.height * scale;
        ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);
        const overlayHeight = 50; ctx.fillStyle = 'rgba(0, 0, 0, 0.6)'; ctx.fillRect(0, canvas.height - overlayHeight, canvas.width, overlayHeight);
        ctx.fillStyle = 'white'; ctx.font = 'bold 24px "Malgun Gothic", sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        const infoText = `[${currentEditItem.shortNum}ë²ˆ ìš©ìˆ˜] ë‹´ë‹¹ì: ${currentEditItem.mgrName}`;
        ctx.fillText(infoText, canvas.width / 2, canvas.height - (overlayHeight / 2));
    }

    canvas.addEventListener('click', function(e) {
        ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height); drawBaseImageWithOverlay(); 
        const rect = canvas.getBoundingClientRect(); const x = (e.clientX - rect.left) * (canvas.width / rect.width); const y = (e.clientY - rect.top) * (canvas.height / rect.height);
        ctx.beginPath(); ctx.arc(x, y, 40, 0, 2 * Math.PI); ctx.lineWidth = 5; ctx.strokeStyle = '#f1c40f'; ctx.stroke(); ctx.fillStyle = 'rgba(241, 196, 15, 0.3)'; ctx.fill();
    });

    function saveEditedPhoto() {
        if (!currentEditItem) return;
        const fileName = `${currentEditItem.shortNum}ë²ˆìš©ìˆ˜-${currentEditItem.mgrName}.jpg`;
        const link = document.createElement('a'); link.download = fileName; link.href = canvas.toDataURL('image/jpeg', 0.9); link.click();
        closeStatusModal(); 
    }

    function cancelPhotoEdit() { clearCanvas(); document.getElementById('photo-editor-area').style.display = 'none'; document.getElementById('default-info-area').style.display = 'block'; cameraInput.value = ''; }
    function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); originalImage = null; }

    function resetWork() { 
        if(!confirm("ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì„œë²„ ë°ì´í„°ëŠ” ìœ ì§€ë©ë‹ˆë‹¤)")) return; 
        if(syncInterval) clearInterval(syncInterval); document.getElementById('sync-indicator').style.display = 'none';
        workbook = null; worksheet = null; loadedRows = []; currentEditItem = null; markers.forEach(m => map.removeLayer(m)); markers = []; document.getElementById('listBody').innerHTML = '<tr><td colspan="9" style="padding:40px; color:#aaa; text-align:center;">ì—‘ì…€ íŒŒì¼ì„ ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>'; document.getElementById('file-status').innerHTML = 'íŒŒì¼ì„ í„°ì¹˜í•˜ê±°ë‚˜<br>ë“œë˜ê·¸í•˜ì„¸ìš”'; document.getElementById('count-badge').innerText = '0ê±´'; document.getElementById('excelFile').value = ''; map.setView([35.32, 126.98], 11); 
    }

    async function exportExcel() {
        if(loadedRows.length === 0) return alert("ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì„ ë¨¼ì € ë¡œë“œí•˜ì„¸ìš”.");
        document.getElementById('loading-msg').innerText = "ì—‘ì…€ ìƒì„± ì¤‘..."; document.getElementById('loading').style.display = 'flex';
        try {
            const newWb = new ExcelJS.Workbook(); const newWs = newWb.addWorksheet('ì ê²€ê²°ê³¼');
            newWs.addRow(['ì—°ë²ˆ', 'ë²ˆí˜¸', 'ì ê²€ìƒíƒœ', 'íŠ¹ì´ì‚¬í•­', 'ë‹´ë‹¹ì', 'ë„ë¡œëª…', 'ì§€ë²ˆ', 'ìƒì„¸ìœ„ì¹˜', 'í‘œì§€', 'ì œìˆ˜', 'ë³´í˜¸']); 
            newWs.getRow(1).font = { bold: true }; newWs.getRow(1).alignment = { horizontal: 'center' };
            const targetNames = Array.from(document.querySelectorAll('.mgr-check:checked')).map(c => c.value);
            let count = 1;
            loadedRows.forEach(item => {
                const r = item.row; const mgr = (r.getCell(COL.MGR).value || "").toString().trim();
                if(targetNames.includes(mgr) || targetNames.length === 0) {
                    let fullNum = (r.getCell(COL.NUM).value || "").toString(); let road = (r.getCell(COL.ROAD).value || "").toString(); let jibun = (r.getCell(COL.JIBUN).value || "").toString(); let detail = (r.getCell(COL.DETAIL).value || "").toString(); let sign = (r.getCell(COL.SIGN).value || "").toString(); let valve = (r.getCell(COL.VALVE).value || "").toString(); let guard = (r.getCell(COL.GUARD).value || "").toString();
                    newWs.addRow([count++, fullNum, item.status, item.memo || "", mgr, road, jibun, detail, sign, valve, guard]);
                }
            });
            newWs.columns = [{ width: 6 }, { width: 15 }, { width: 10 }, { width: 25 }, { width: 10 }, { width: 25 }, { width: 25 }, { width: 30 }, { width: 10 }, { width: 10 }, { width: 10 }];
            const buffer = await newWb.xlsx.writeBuffer(); const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); const today = new Date().toISOString().slice(2,10).replace(/-/g,''); link.download = `ì†Œë°©ìš©ìˆ˜_ì‹¤ì‹œê°„ì €ì¥ë³¸_${today}.xlsx`; link.click(); alert("í˜„ì¥ ë°ì´í„°ê°€ ë°˜ì˜ëœ ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch(err) { alert("ì—‘ì…€ ìƒì„± ì¤‘ ì˜¤ë¥˜: " + err.message); } finally { document.getElementById('loading').style.display = 'none'; document.getElementById('loading-msg').innerText = "ì²˜ë¦¬ ì¤‘..."; }
    }

    let gpsWatchId = null; let userMarker = null; 
    function toggleGPS() {
        const btn = document.getElementById('gps-btn');
        if (gpsWatchId) { navigator.geolocation.clearWatch(gpsWatchId); gpsWatchId = null; if (userMarker) { map.removeLayer(userMarker); userMarker = null; } btn.innerText = "ğŸ¯ ë‚´ ìœ„ì¹˜ í‘œì‹œ"; btn.classList.remove('active'); return; }
        if (!navigator.geolocation) return alert("ìŠ¤ë§ˆíŠ¸í°ì˜ ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì¼œì£¼ì„¸ìš”.");
        btn.innerText = "â¹ï¸ ìœ„ì¹˜ í‘œì‹œ ë„ê¸°"; btn.classList.add('active');
        gpsWatchId = navigator.geolocation.watchPosition(
            (position) => {
                const latlng = [position.coords.latitude, position.coords.longitude];
                if (!userMarker) { userMarker = L.circleMarker(latlng, { color: '#3498db', radius: 8, fillOpacity: 1, border: '2px solid white' }).addTo(map); map.setView(latlng, 17); } 
                else { userMarker.setLatLng(latlng); }
            },
            (error) => { alert("GPS ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); toggleGPS(); }, { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
        );
    }

    function initResizableColumns() {
        const table = document.querySelector('.info-table'); if(!table) return; const cols = table.querySelectorAll('th'); table.querySelectorAll('.resizer').forEach(e => e.remove()); table.classList.remove('resizing-active');
        [].forEach.call(cols, function (col) {
            const resizer = document.createElement('div'); resizer.classList.add('resizer'); col.appendChild(resizer); let x = 0, w = 0, tableStartWidth = 0;
            const mouseDownHandler = function (e) { x = e.clientX; w = col.offsetWidth; tableStartWidth = table.offsetWidth; if(!table.classList.contains('resizing-active')) { table.classList.add('resizing-active'); cols.forEach(c => { c.style.width = `${c.offsetWidth}px`; }); table.style.width = `${table.offsetWidth}px`; } document.addEventListener('mousemove', mouseMoveHandler); document.addEventListener('mouseup', mouseUpHandler); resizer.classList.add('resizing'); document.body.style.userSelect = 'none'; };
            const mouseMoveHandler = function (e) { const dx = e.clientX - x; col.style.width = `${w + dx}px`; table.style.width = `${tableStartWidth + dx}px`; };
            const mouseUpHandler = function () { resizer.classList.remove('resizing'); document.removeEventListener('mousemove', mouseMoveHandler); document.removeEventListener('mouseup', mouseUpHandler); document.body.style.userSelect = ''; };
            resizer.addEventListener('mousedown', mouseDownHandler); resizer.addEventListener('touchstart', (e) => mouseDownHandler(e.touches[0]));
        });
    }
</script>
</body>
</html>
