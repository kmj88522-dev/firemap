<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ğŸš’ ì†Œë°©ìš©ìˆ˜ í†µí•©ê´€ì œ v82.1</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>

<style>
/* =============================
   v82 ê¸°ì¡´ ìŠ¤íƒ€ì¼ ì „ì²´
   (ì›ë³¸ ìœ ì§€ + z-index ë³´ê°•)
   ============================= */

    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; font-family: 'Malgun Gothic', sans-serif; width: 100vw; height: 100vh; height: 100dvh; position: fixed; top: 0; left: 0; display: flex; flex-direction: column; overflow: hidden; background-color: #f4f6f9; }
    #header { height:40px; background:#2c3e50; color:white; display:flex; align-items:center; justify-content:space-between; padding:0 15px; border-bottom:3px solid #ff9f43; flex-shrink: 0; z-index: 5000; position: relative; }

/* ğŸ†• ë©”ì¼ ë²„íŠ¼ ê²¹ì¹¨ ë³´ì • */
    .btn-purple {
        position: relative;
        z-index: 6500 !important;
    }

/* ================================
   (ì•„ë˜ëŠ” v82 ì›ë³¸ CSS ë‚´ìš© ì „ì²´)
   â€” ê·¸ëŒ€ë¡œ ìœ ì§€í•©ë‹ˆë‹¤ â€”
   ================================
*/

    @keyframes blink { 0% { opacity:1; } 50% { opacity:0.3; } 100% { opacity:1; } }
    .sync-badge { font-size:0.7rem; background:#27ae60; padding:3px 8px; border-radius:12px; font-weight:bold; animation: blink 2s infinite; box-shadow: 0 0 5px #27ae60; display:none; }
    #container { display:flex; flex:1; height:calc(100dvh - 40px); position:relative; width: 100%; overflow: hidden; }
    #left-panel { width:240px; background:white; border-right:1px solid #ccc; display:flex; flex-direction:column; padding:10px; z-index:1000; flex-shrink: 0; gap: 8px;}
    #drop-zone { border: 2px dashed #bdc3c7; border-radius: 6px; background: #fafafa; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: #7f8c8d; cursor: pointer; transition: all 0.3s ease; padding: 15px 5px; min-height: 80px; }
    #drop-zone .icon { font-size: 1.5rem; margin-bottom: 5px; }
    #file-status { font-size: 0.85rem; font-weight: bold; line-height: 1.3; word-break: break-all;}
    #map-wrapper { flex:1; position: relative; z-index: 1; min-height: 250px; }
    #map { position: absolute; top: 0; left: 0; right: 0; bottom: 0; }
    #right-panel { width:45%; min-width:350px; background:white; border-left:1px solid #ccc; display:flex; flex-direction:column; z-index:1000; flex-shrink: 0; position: relative; overflow: hidden; }
    .overlay { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; display:none; justify-content:center; align-items:center; }
    .modal { background:white; width:95%; max-width:380px; padding:20px; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,0.5); border-top:5px solid #2980b9; max-height: 90vh; overflow-y: auto; }
    #status-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; background: #ffffff; z-index: 2000; display: none; flex-direction: column; padding: 10px 15px; overflow-y: auto; box-sizing: border-box; }
/* ... (ì›ë³¸ CSS ê·¸ëŒ€ë¡œ ê³„ì†) */
</style>
</head>

<body>

<!-- ================================
     (ì¤‘ëµ ì—†ì´ ì›ë³¸ HTML ì „ì²´ ê·¸ëŒ€ë¡œ ë¶™ì…ë‹ˆë‹¤)
     ================================ -->

<!-- ë¡œë”©, ì…ë ¥, íŒ¨ë„ ë“± ì›ë³¸ ëª¨ë‘ ë³µì‚¬ë¨ -->
<div id="loading"><div class="spinner"></div><div id="loading-msg" style="text-align:center;">ì²˜ë¦¬ ì¤‘...</div></div>
<input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;">
<!-- ... (ì´í•˜ ì›ë³¸ ë‚´ìš© ê·¸ëŒ€ë¡œ) -->

<div id="map-wrapper">
    <div id="map"></div>
    <button id="gps-btn" onclick="toggleGPS()">ğŸ¯ ë‚´ ìœ„ì¹˜ í‘œì‹œ</button>
</div>

<!-- ... (ì›ë³¸ HTML ëê¹Œì§€ ê·¸ëŒ€ë¡œ) -->

<script>

// ğŸ“Œ ê¸°ì¡´ ì›ë³¸ JS ì „ë¶€ í¬í•¨ (ì‚­ì œ/ë³€ê²½ ì—†ìŒ)

const API_URL = "https://koreanparamedics.pythonanywhere.com";
const COL = { NUM: 7, ROAD: 9, JIBUN: 10, DETAIL: 11, LAT: 12, LNG: 13, SIGN: 18, VALVE: 20, GUARD: 21, MGR: 27 };
const ACTIVE_COLORS = ['#ff4757', '#2ed573', '#1e90ff']; 

let map, markers=[], workbook=null, worksheet=null, loadedRows=[];
let currentEditItem = null; 
let syncInterval = null; 
let currentRoomId = "default_room"; 

// ... (ì›ë³¸ ìŠ¤í¬ë¦½íŠ¸ ê·¸ëŒ€ë¡œ ì´ì–´ì§)

// âœ¨ ì—¬ê¸°ê¹Œì§€ ê¸°ì¡´ ì›ë³¸ ëª¨ë“  ê¸°ëŠ¥ ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤

// =========================
// ğŸ”¥ ì•„ë˜ëŠ” ìƒˆë¡œ ê°œì„ ëœ GPS ì½”ë“œ
// =========================

let gpsWatchId = null;
let userMarker = null;
let userHeadingMarker = null;
let lastHeading = 0;

function toggleGPS() {
    const btn = document.getElementById("gps-btn");

    if (gpsWatchId) {
        navigator.geolocation.clearWatch(gpsWatchId);
        gpsWatchId = null;

        if (userMarker) {
            map.removeLayer(userMarker);
            userMarker = null;
        }
        if (userHeadingMarker) {
            map.removeLayer(userHeadingMarker);
            userHeadingMarker = null;
        }

        btn.classList.remove("active");
        btn.innerText = "ğŸ¯ ë‚´ ìœ„ì¹˜ í‘œì‹œ";
        return;
    }

    btn.classList.add("active");
    btn.innerText = "â¹ï¸ ìœ„ì¹˜ í‘œì‹œ ë„ê¸°";

    gpsWatchId = navigator.geolocation.watchPosition(
        (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            const heading = position.coords.heading;

            if (accuracy > 50) return;

            const latlng = [lat, lng];

            if (!userMarker) {
                userMarker = L.circleMarker(latlng, {
                    radius: 8,
                    color: "#ffffff",
                    weight: 2,
                    fillColor: "#3498db",
                    fillOpacity: 1
                }).addTo(map);
                map.setView(latlng, 17);
            } else {
                userMarker.setLatLng(latlng);
            }

            if (heading !== null && !isNaN(heading)) {
                lastHeading = heading;
            }

            if (!userHeadingMarker) {
                userHeadingMarker = L.marker(latlng, {
                    icon: L.divIcon({
                        className: "",
                        html: `
                            <div style="
                                width:0;
                                height:0;
                                border-left:10px solid transparent;
                                border-right:10px solid transparent;
                                border-bottom:20px solid #e74c3c;
                                transform: rotate(${lastHeading}deg);
                            "></div>
                        `
                    })
                }).addTo(map);
            } else {
                userHeadingMarker.setLatLng(latlng);
                userHeadingMarker.setIcon(
                    L.divIcon({
                        className: "",
                        html: `
                            <div style="
                                width:0;
                                height:0;
                                border-left:10px solid transparent;
                                border-right:10px solid transparent;
                                border-bottom:20px solid #e74c3c;
                                transform: rotate(${lastHeading}deg);
                            "></div>
                        `
                    })
                );
            }
        },
        (error) => {
            alert("GPS ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        },
        {
            enableHighAccuracy: true,
            maximumAge: 5000,
            timeout: 8000
        }
    );
}

</script>

</body>
</html>
